<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OG Capper Bets - Ticket</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    input, button {
      font-size: 1.2rem;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    input {
      width: 300px;
    }
    .ticket {
      background: #fff;
      padding: 1.5rem;
      margin-top: 2rem;
      border: 2px dashed #000;
      width: 350px;
    }
    .ticket-title {
      font-weight: bold;
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .error {
      color: red;
      margin-top: 1rem;
    }
    #loaderCircle {
      width: 100px;
      height: 100px;
      border: 10px solid #444;
      border-top: 10px solid #0f0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    #loadTextBox {
      background: #222;
      color: #0f0;
      font-size: 0.9rem;
      width: 320px;
      height: 3.5em;
      overflow-y: auto;
      padding: 0.5em;
      line-height: 1.2em;
      white-space: pre-line;
      border: 1px solid #0f0;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2 style="color: white;">OG Capper Bets Ticket</h2>
  <div id="loaderCircle"></div>
  <div id="loadTextBox"></div>
  <input id="betInput" type="text" placeholder="e.g. Yankees ML 1.5u" style="display:none" />
  <button onclick="createTicket()" style="display:none">Generate Ticket</button>
  <div id="ticket"></div>
  <div id="error" class="error"></div>

  <script>
    const sportsdbKey = "123";
    let cachedGames = [];

    async function logLoadingStep(msg) {
      const box = document.getElementById("loadTextBox");
      box.textContent += `${msg}\n`;
      box.scrollTop = box.scrollHeight;
    }

    async function fetchGamesFromSportsDB() {
      const now = new Date();
      const twelveHoursAgo = new Date(now.getTime() - 12 * 60 * 60 * 1000);
      const fortyEightHoursLater = new Date(now.getTime() + 48 * 60 * 60 * 1000);

      const allLeaguesURL = `https://www.thesportsdb.com/api/v1/json/${sportsdbKey}/all_leagues.php`;
      const leagueRes = await fetch(allLeaguesURL);
      const leagueData = await leagueRes.json();
      const leagues = leagueData.leagues || [];

      for (const league of leagues.slice(0, 50)) {
        await logLoadingStep(`Loading: ${league.strLeague}`);
        try {
          const eventsRes = await fetch(`https://www.thesportsdb.com/api/v1/json/${sportsdbKey}/eventsnextleague.php?id=${league.idLeague}`);
          const eventsData = await eventsRes.json();
          const events = eventsData.events || [];

          const filtered = events.filter(e => {
            const dt = new Date(`${e.dateEvent}T${e.strTime || '00:00:00'}Z`);
            return dt >= twelveHoursAgo && dt <= fortyEightHoursLater;
          });

          cachedGames.push(...filtered);
        } catch (err) {
          continue;
        }
      }
    }

    async function loadData() {
      await logLoadingStep("Fetching games from SportsDB...");
      await fetchGamesFromSportsDB();
      document.getElementById("loaderCircle").style.display = "none";
      document.getElementById("loadTextBox").style.display = "none";
      document.getElementById("betInput").style.display = "block";
      document.querySelector("button").style.display = "block";
    }

    async function createTicket() {
      const input = document.getElementById("betInput").value.trim();
      const matchParts = input.match(/^(.*?)\s+(\S+)\s+(\d+(\.\d+)?)(u?)$/i);

      if (!matchParts) {
        document.getElementById('error').textContent = "Invalid format. Try: Yankees ML 1.5u";
        return;
      }

      const teamQuery = matchParts[1].toLowerCase();
      const betType = matchParts[2];
      const units = matchParts[3];

      const matchedGame = cachedGames.find(game =>
        (game.strHomeTeam && game.strHomeTeam.toLowerCase().includes(teamQuery)) ||
        (game.strAwayTeam && game.strAwayTeam.toLowerCase().includes(teamQuery))
      );

      if (!matchedGame) {
        document.getElementById('error').textContent = "Game not found. Try a different team.";
        return;
      }

      const team = matchedGame.strHomeTeam.toLowerCase().includes(teamQuery) ? matchedGame.strHomeTeam : matchedGame.strAwayTeam;
      const opponent = matchedGame.strHomeTeam.toLowerCase().includes(teamQuery) ? matchedGame.strAwayTeam : matchedGame.strHomeTeam;

      const ticketHTML = `
        <div class='ticket'>
