<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OG Capper Bets Ticket</title>
  <style>
    body {
      background: #0c0c0c;
      font-family: monospace;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    #loaderWrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .circular-loader {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 10px solid #1f1f1f;
      border-top: 10px solid #00ff99;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    #progressLog {
      width: 320px;
      height: 4.5em;
      overflow-y: auto;
      border: 2px solid #00ff99;
      padding: 0.5em;
      font-size: 0.9rem;
      background: #111;
      color: #00ffcc;
    }
    #inputSection {
      display: none;
      margin-top: 2rem;
      text-align: center;
    }
    input {
      font-size: 1.2rem;
      padding: 0.5rem;
      width: 300px;
    }
    button {
      font-size: 1rem;
      padding: 0.5rem 1rem;
      margin-left: 1rem;
    }
    .error {
      color: red;
      margin-top: 1rem;
    }
    .ticket {
      background: #fff;
      color: #000;
      padding: 1.5rem;
      margin-top: 2rem;
      border: 2px dashed #000;
      width: 350px;
    }
    .ticket-title {
      font-weight: bold;
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div id="loaderWrapper">
    <div class="circular-loader" id="circularLoader"></div>
    <div id="progressLog"></div>
  </div>

  <div id="inputSection">
    <h2>OG Capper Bets Ticket</h2>
    <input id="betInput" type="text" placeholder="e.g. Yankees ML 1.5u" />
    <button onclick="createTicket()">Generate Ticket</button>
    <div id="error" class="error"></div>
    <div id="ticket"></div>
  </div>

  <script>
    let allEvents = [];

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed: ${url}`);
      return res.json();
    }

    async function loadData() {
      const log = document.getElementById('progressLog');
      const logLine = txt => {
        log.innerHTML += `<div>${txt}</div>`;
        log.scrollTop = log.scrollHeight;
      };

      try {
        logLine('üîÑ Fetching all sports from SportsDB...');
        const sports = await fetchJSON('https://www.thesportsdb.com/api/v1/json/123/all_sports.php');

        const sportKeys = sports.sports.map(s => s.strSport);

        for (let sport of sportKeys) {
          logLine(`üì° Pulling events for: ${sport}...`);
          const url = `https://www.thesportsdb.com/api/v1/json/123/eventspastleague.php?id=${sport}`;
          try {
            const events = await fetchJSON(url);
            if (events && events.events) allEvents.push(...events.events);
          } catch (e) {
            logLine(`‚ö†Ô∏è Failed loading events for ${sport}`);
          }
        }

        logLine('‚úÖ All event data stored in memory.');
        document.getElementById('loaderWrapper').style.display = 'none';
        document.getElementById('inputSection').style.display = 'block';

      } catch (e) {
        logLine('‚ùå Critical error loading sports or events.');
        console.error(e);
      }
    }

    function createTicket() {
      const input = document.getElementById('betInput').value.trim();
      const match = input.match(/^(.*?)\s+(ml|spread|total|tt|f5)\s+(\d+(\.\d+)?)(u?)$/i);
      const err = document.getElementById('error');
      err.textContent = "";

      if (!match) {
        err.textContent = "Invalid format. Try: Yankees ML 1.5u";
        return;
      }

      const teamQuery = match[1].toLowerCase();
      const type = match[2];
      const wager = match[3];

      const found = allEvents.find(ev =>
        ev.strHomeTeam?.toLowerCase().includes(teamQuery) ||
        ev.strAwayTeam?.toLowerCase().includes(teamQuery)
      );

      if (!found) {
        err.textContent = "No game found matching that team.";
        return;
      }

      const team = found.strHomeTeam.toLowerCase().includes(teamQuery) ? found.strHomeTeam : found.strAwayTeam;
      const opponent = found.strHomeTeam === team ? found.strAwayTeam : found.strHomeTeam;

      const ticketHTML = `
        <div class='ticket'>
          <div class='ticket-title'>üèÅ OG CAPPER BETS</div>
          <hr>
          <p><strong>EVENT:</strong> ${found.strEvent}</p>
          <p><strong>DATE:</strong> ${found.dateEvent} ${found.strTime || ''}</p>
          <hr>
          <p><strong>SELECTION:</strong> ${team} ${type.toUpperCase()}</p>
          <p><strong>WAGER:</strong> ${wager} unit(s)</p>
          <hr>
          <p style='text-align:center;'>ALL SALES FINAL ‚Äì NO CANCELLATION</p>
        </div>
      `;
      document.getElementById('ticket').innerHTML = ticketHTML;
    }

    window.onload = loadData;
  </script>
</body>
</html>
