<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OG Capper Bets - Ticket</title>
  <style>
    body {
      font-family: monospace;
      background: #000;
      color: #0f0;
      text-align: center;
      padding: 2rem;
    }
    .loader-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .progress-circle {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 8px solid #111;
      border-top: 8px solid #0f0;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
      position: relative;
    }
    .percent-label {
      position: absolute;
      top: 35%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.4rem;
      font-weight: bold;
      color: white;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #log {
      height: 4.5em;
      overflow-y: scroll;
      border: 2px solid lime;
      padding: 0.5em;
      width: 300px;
      margin: 0 auto;
      background: #111;
      color: #0ff;
      font-size: 0.9em;
      text-align: left;
    }
    #mainUI {
      display: none;
      margin-top: 2rem;
    }
    input {
      font-size: 1rem;
      padding: 0.4rem;
      width: 300px;
      margin-right: 1rem;
    }
    button {
      font-size: 1rem;
      padding: 0.5rem;
    }
    .error { color: red; margin-top: 1rem; }
  </style>
</head>
<body>
  <div id="loader" class="loader-container">
    <h2>OG Capper Bets Ticket</h2>
    <div class="progress-circle" id="circle">
      <span class="percent-label" id="percent">0%</span>
    </div>
    <div id="log"></div>
  </div>

  <div id="mainUI">
    <h2>OG Capper Bets Ticket</h2>
    <input id="betInput" type="text" placeholder="e.g. Seattle ML 1u" />
    <button onclick="generateTicket()">Generate Ticket</button>
    <div class="error" id="error"></div>
    <div id="ticket"></div>
  </div>

  <script>
    let teamsList = [];

    function updateLog(msg, isError = false) {
      const log = document.getElementById("log");
      const line = document.createElement("div");
      line.textContent = (isError ? "‚ùå " : "‚Ä¢ ") + msg;
      line.style.color = isError ? "red" : "aqua";
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }

    function updatePercent(p) {
      document.getElementById("percent").textContent = `${p}%`;
    }

    async function loadData() {
      try {
        updateLog("Fetching all sports from SportsDB...");
        const res = await fetch("https://www.thesportsdb.com/api/v1/json/123/all_sports.php");
        const data = await res.json();
        const sports = data.sports.map(s => s.strSport);

        let count = 0;
        for (let sport of sports) {
          updateLog(`Fetching teams for: ${sport}...`);
          try {
            const teamRes = await fetch(`https://www.thesportsdb.com/api/v1/json/123/search_all_teams.php?s=${encodeURIComponent(sport)}`);
            const teamData = await teamRes.json();
            if (teamData.teams) {
              teamsList.push(...teamData.teams);
            }
          } catch (err) {
            updateLog(`Failed to load data for ${sport}`, true);
          }
          count++;
          updatePercent(Math.floor((count / sports.length) * 100));
        }

        updateLog(`Indexed ${teamsList.length} teams.`);
        document.getElementById("loader").style.display = "none";
        document.getElementById("mainUI").style.display = "block";
      } catch (e) {
        updateLog("Failed to load initial data.", true);
        console.error(e);
      }
    }

    async function generateTicket() {
      const input = document.getElementById("betInput").value.trim();
      const error = document.getElementById("error");
      const ticket = document.getElementById("ticket");
      error.textContent = "";
      ticket.innerHTML = "";

      const match = input.match(/^(.*?)\s+(\S+)\s+(\d+(\.\d+)?)(u)?$/i);
      if (!match) {
        error.textContent = "Invalid input. Try format: TeamName ML 1u";
        return;
      }

      const teamQuery = match[1].toLowerCase();
      const betType = match[2];
      const units = match[3];

      const matches = teamsList.filter(t => t.strTeam.toLowerCase().includes(teamQuery));

      if (matches.length === 0) {
        error.textContent = "‚ùå No team found.";
        return;
      }

      const team = matches[0]; // first match only for now
      const html = `
        <div class='ticket'>
          <div class='ticket-title'>üèë OG CAPPER BETS</div>
          <hr>
          <p><strong>TEAM:</strong> ${team.strTeam}</p>
          <p><strong>LEAGUE:</strong> ${team.strLeague}</p>
          <p><strong>BET:</strong> ${betType}</p>
          <p><strong>UNITS:</strong> ${units}</p>
          <hr>
          <p style='text-align:center;'>ALL SALES FINAL ‚Äì NO CANCELLATION</p>
        </div>
      `;
      ticket.innerHTML = html;
    }

    window.onload = loadData;
  </script>
</body>
</html>
