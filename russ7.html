<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OG Capper Bets Ticket</title>
  <style>
    body {
      background: #000;
      color: #0f0;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    #loaderBox {
      text-align: center;
      margin-bottom: 2rem;
    }
    #log {
      background: #111;
      border: 2px solid #0f0;
      padding: 1rem;
      width: 300px;
      height: 100px;
      overflow-y: scroll;
      margin: 1rem auto;
      color: cyan;
      font-size: 0.9rem;
    }
    #progress {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 10px solid #333;
      border-top: 10px solid #0f0;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    #progressLabel {
      margin-top: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden { display: none; }
    #ticketBox {
      margin-top: 2rem;
      text-align: center;
    }
    input, button {
      font-size: 1rem;
      padding: 0.5rem;
      margin: 0.5rem;
    }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>OG Capper Bets Ticket</h1>
  <div id="loaderBox">
    <div id="progress"></div>
    <div id="progressLabel">Loading...</div>
    <div id="log"></div>
  </div>

  <div id="ticketBox" class="hidden">
    <input id="betInput" type="text" placeholder="e.g. Seattle ML 1u" />
    <button onclick="generateTicket()">Generate Ticket</button>
    <div id="error" class="error"></div>
    <div id="output"></div>
  </div>

  <script>
    const API_BASE = 'https://www.thesportsdb.com/api/v1/json/123';
    const logEl = document.getElementById('log');
    const loaderBox = document.getElementById('loaderBox');
    const ticketBox = document.getElementById('ticketBox');
    const progressLabel = document.getElementById('progressLabel');

    let teamsIndex = [];

    function log(msg, isError = false) {
      const line = document.createElement('div');
      line.textContent = `${isError ? '‚úñ' : '‚Ä¢'} ${msg}`;
      line.style.color = isError ? 'red' : 'cyan';
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function loadData() {
      log('Fetching all sports from SportsDB...');
      let sportsResp = await fetch(`${API_BASE}/all_sports.php`).then(r => r.json()).catch(() => null);
      if (!sportsResp || !sportsResp.sports) {
        log('Failed to load sports.', true);
        return;
      }

      let sports = sportsResp.sports;
      for (let sport of sports) {
        let name = sport.strSport;
        log(`Fetching teams for: ${name}...`);
        try {
          let teamResp = await fetch(`${API_BASE}/search_all_teams.php?s=${encodeURIComponent(name)}`).then(r => r.json());
          if (teamResp && Array.isArray(teamResp.teams)) {
            teamsIndex.push(...teamResp.teams.map(t => ({ name: t.strTeam, sport: name, id: t.idTeam })));
          } else {
            log(`No teams found for: ${name}`, true);
          }
        } catch (e) {
          log(`Failed to load data for ${name}`, true);
        }
      }
      log(`Indexed ${teamsIndex.length} teams.`);
      progressLabel.textContent = '‚úÖ Done';
      loaderBox.classList.add('hidden');
      ticketBox.classList.remove('hidden');
    }

    function generateTicket() {
      const input = document.getElementById('betInput').value.trim();
      const match = input.match(/^(.*?)\s+(ml|spread|total|tt)\s+(\d+(\.\d+)?)(u)$/i);
      const errorEl = document.getElementById('error');
      const output = document.getElementById('output');
      errorEl.textContent = '';
      output.textContent = '';

      if (!match) {
        errorEl.textContent = 'Invalid format. Try: Seattle ML 1u';
        return;
      }

      const queryTeam = match[1].toLowerCase();
      const betType = match[2].toUpperCase();
      const units = match[3];

      const matched = teamsIndex.filter(t => t.name && t.name.toLowerCase().includes(queryTeam));

      if (matched.length === 0) {
        errorEl.textContent = 'No team found.';
        return;
      } else if (matched.length > 1) {
        errorEl.textContent = `Multiple matches found: ${matched.map(m => m.name).join(', ')}`;
        return;
      }

      const team = matched[0];
      const now = new Date().toLocaleString();

      output.innerHTML = `
        <pre style="text-align:left; background:#fff; color:#000; padding:1rem; border:2px dashed #000; width: 300px;">
üèÅ OG CAPPER BETS
----------------------------
TEAM: ${team.name}
SPORT: ${team.sport}
BET: ${betType} ${units}u
DATE: ${now}
----------------------------
ALL SALES FINAL ‚Äì NO CANCELLATION
        </pre>
      `;
    }

    loadData();
  </script>
</body>
</html>
