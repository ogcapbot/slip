<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OG Capper Bets Ticket</title>
  <style>
    body {
      font-family: monospace;
      background: #000;
      color: #0fffcf;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 10px solid #222;
      border-top-color: #00ff95;
      animation: spin 1s linear infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 2rem;
    }
    @keyframes spin {
      0% { transform: rotate(0); }
      100% { transform: rotate(360deg); }
    }
    #log {
      width: 350px;
      height: 4.5em;
      overflow-y: auto;
      background: #111;
      border: 2px solid #00ff95;
      padding: 0.5rem;
      font-size: 0.9rem;
      color: #fff;
      margin-top: 1rem;
    }
    #inputSection {
      display: none;
      flex-direction: row;
      gap: 1rem;
      margin-top: 2rem;
    }
    input {
      font-size: 1.1rem;
      padding: 0.5rem;
      width: 300px;
    }
    button {
      font-size: 1rem;
      padding: 0.5rem 1rem;
    }
    #error {
      color: red;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h2>OG Capper Bets Ticket</h2>
  <div class="circle" id="progress">0%</div>
  <div id="log"></div>

  <div id="inputSection">
    <input id="betInput" type="text" placeholder="e.g. Seattle ML 1u" />
    <button onclick="createTicket()">Generate Ticket</button>
  </div>
  <div id="error"></div>

  <script>
    const apiKey = '123';
    const logEl = document.getElementById("log");
    const progressEl = document.getElementById("progress");
    const allTeams = [];

    async function appendLog(msg, isError = false) {
      logEl.innerHTML += `<div style="color:${isError ? 'red' : 'inherit'}">${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function loadData() {
      try {
        appendLog("• Fetching all sports from SportsDB...");
        const res = await fetch(`https://www.thesportsdb.com/api/v1/json/${apiKey}/all_sports.php`);
        const data = await res.json();
        const sports = data.sports || [];

        for (let i = 0; i < sports.length; i++) {
          const sport = sports[i];
          const sportName = sport.strSport;

          appendLog(`• Fetching teams for: ${sportName}...`);
          try {
            const teamRes = await fetch(`https://www.thesportsdb.com/api/v1/json/${apiKey}/search_all_teams.php?s=${encodeURIComponent(sportName)}`);
            const teamData = await teamRes.json();
            const teams = teamData.teams || [];
            teams.forEach(team => {
              allTeams.push({
                name: team.strTeam,
                idTeam: team.idTeam,
                league: team.strLeague,
                sport: sportName
              });
            });
          } catch (err) {
            appendLog(`❌ Failed to load data for ${sportName}`, true);
          }

          const percent = Math.floor(((i + 1) / sports.length) * 100);
          progressEl.textContent = `${percent}%`;
        }

        appendLog("✔️ Done loading all data.");
        document.getElementById("inputSection").style.display = "flex";
        progressEl.textContent = "100%";
        progressEl.style.animation = "none";
        progressEl.style.backgroundColor = "#00ff95";
        progressEl.style.color = "#000";
      } catch (err) {
        appendLog("❌ Failed to load initial sports.", true);
        console.error(err);
      }
    }

    function createTicket() {
      const input = document.getElementById("betInput").value.trim();
      const match = input.match(/^(.*?)\s+(\w+)\s+(\d+(\.\d+)?)(u)?$/i);
      const errorEl = document.getElementById("error");
      errorEl.textContent = "";

      if (!match) {
        errorEl.textContent = "Invalid format. Try: Seattle ML 1u";
        return;
      }

      const query = match[1].toLowerCase();
      const teamMatches = allTeams.filter(t => t.name.toLowerCase().includes(query));

      if (teamMatches.length === 0) {
        errorEl.textContent = "No team found matching that name.";
        return;
      }

      if (teamMatches.length > 1) {
        errorEl.innerHTML = `⚠️ Multiple teams match that name:<br>${teamMatches.map(t => t.name).join("<br>")}`;
        return;
      }

      const selected = teamMatches[0];
      alert(`✅ Ticket generated for ${selected.name} in ${selected.sport} / ${selected.league}`);
    }

    window.onload = loadData;
  </script>
</body>
</html>
