<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OG Capper Bets</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0 auto;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 8px;
      box-sizing: border-box;
      max-width: 100%;
    }
    button:active {
      transform: scale(0.98);
      background-color: #0c0;
    }
    button {
      background: #0f0;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.1s ease-in-out;
    }
    #loader, #betInput, #results, #multiSelect {
      display: none;
    }
    #log {
      background: #222;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
      max-height: 200px;
      overflow-y: scroll;
      white-space: pre-wrap;
    }
    #continueButton {
      display: none;
      margin-top: 10px;
    }
    .ticket {
      background: #000;
      border: 1px solid #fff;
      padding: 20px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      margin-top: 20px;
    }
    .team-option {
      padding: 10px;
      background: #444;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 5px;
    }
    .team-option:hover {
      background: #666;
    }
    @media (max-width: 480px) {
      input, button {
        font-size: 14px;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="access">
    <h2>Enter Access Code</h2>
    <input id="codeInput" type="number" inputmode="numeric" pattern="\d*" minlength="3" maxlength="8" placeholder="Access Code" />
    <button onclick="validateCode()">Submit</button>
    <p id="authMessage"></p>
  </div>

  <div id="loader">
    <h3>Loading Games...</h3>
    <div id="log"></div>
    <button id="continueButton" onclick="showBetInput()">Continue</button>
  </div>

  <div id="betInput">
    <input id="userInput" placeholder="e.g. cubs ml 1u" />
    <button onclick="processInput()">Create</button>
    <p id="inputError" style="color: red; white-space: pre-wrap;"></p>
  </div>

  <div id="multiSelect"></div>
  <div id="results"></div>

  <script>
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxW55MrRuwPX87F_oCMJpof7HMIKHbyY1evseVm-eEYHEPOSkoHbVD1VUN_rg-vDsQw_Q/exec';
    let cachedGames = [];
    let capperName = "OG Capper";

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('codeInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') validateCode();
      });
      document.getElementById('userInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') processInput();
      });
    });

    function validateCode() {
      const code = document.getElementById('codeInput').value.trim();
      if (/^\d{3,8}$/.test(code)) {
        if (code === '1069') {
          document.getElementById('access').style.display = 'none';
          document.getElementById('loader').style.display = 'block';
          loadGames();
        } else {
          document.getElementById('authMessage').innerText = `The Access Code ${code} is Invalid. Please Enter a Valid Access Code to Continue.`;
        }
      } else {
        document.getElementById('authMessage').innerText = `The Access Code ${code} is Invalid. Please Enter a Valid Access Code to Continue.`;
      }
    }

    async function loadGames() {
      const log = document.getElementById('log');
      log.innerText = 'Fetching games from server...\n';
      try {
        const res = await fetch(WEBAPP_URL);
        const data = await res.json();
        cachedGames = data.map(game => {
          const home = game.teams?.home?.name || game.home_team || "";
          const away = game.teams?.away?.name || game.away_team || "";
          log.innerText += `Loaded: ${home}\nLoaded: ${away}\n`;
          return {
            date: game.fixture?.date || game.date,
            teams: [
              { id: game.teams?.home?.id || game.home_id, name: home },
              { id: game.teams?.away?.id || game.away_id, name: away }
            ]
          };
        });
        log.innerText += `\nTotal games loaded: ${cachedGames.length}`;
        document.getElementById('continueButton').style.display = 'block';
      } catch (err) {
        log.innerText += '\nError loading data.';
      }
    }

    function showBetInput() {
      document.getElementById('loader').style.display = 'none';
      document.getElementById('betInput').style.display = 'block';
    }

    function processInput() {
      document.getElementById('inputError').innerText = '';
      const input = document.getElementById('userInput').value.trim().toLowerCase();
      if (!input) {
        document.getElementById('inputError').innerText = 'Input cannot be empty.';
        return;
      }
      const parts = input.split(' ');
      if (parts.length < 3) {
        document.getElementById('inputError').innerText = 'Input must include a team, bet type, and wager (e.g. "cubs ml 1u").';
        return;
      }
      const teamQuery = parts[0];
      const betType = parts[1];
      const wager = parts[2];

      const matches = cachedGames.filter(game =>
        game.teams && game.teams.some(t => t.name.toLowerCase().includes(teamQuery))
      );

      if (matches.length === 0) {
        document.getElementById('inputError').innerText = `No games found matching: "${teamQuery}"`;
        return;
      } else if (matches.length === 1) {
        renderTicket(matches[0], teamQuery, betType, wager);
      } else {
        const selectDiv = document.getElementById('multiSelect');
        selectDiv.innerHTML = '<p>Multiple teams found. Please select:</p>';
        matches.forEach(game => {
          const team = game.teams.find(t => t.name.toLowerCase().includes(teamQuery));
          const opponent = game.teams.find(t => t.id !== team.id);
          const el = document.createElement('div');
          el.className = 'team-option';
          el.innerText = `${team.name} vs ${opponent.name} on ${new Date(game.date).toLocaleString()}`;
          el.onclick = () => {
            selectDiv.innerHTML = '';
            renderTicket(game, teamQuery, betType, wager);
          };
          selectDiv.appendChild(el);
        });
        selectDiv.style.display = 'block';
      }
    }

    function renderTicket(game, teamQuery, betType, wager) {
      const team = game.teams.find(t => t.name.toLowerCase().includes(teamQuery));
      const opponent = game.teams.find(t => t.id !== team.id);
      const gameTime = new Date(game.date);
      const secondsSince = Math.floor((Date.now() - new Date('1981-07-25T12:00:00-04:00')) / 1000);
      const pickID = `${secondsSince}-${String(gameTime.getMonth()+1).padStart(2,'0')}${String(gameTime.getDate()).padStart(2,'0')}${String(gameTime.getFullYear()).slice(-2)}`;

      const slip = `═══════════════\nOG Capper Bets\nOFFICIAL PICK\n═══════════════\n\nPick: ${team.name}\nBet Type: ${betType.toUpperCase()}\nWager: ${wager.toUpperCase()}\nOpponent: ${opponent.name}\nGame Time: ${gameTime.toLocaleString()}\n\n═══════════════\nTHANK YOU FOR TRUSTING OG CAPPER BETS\n═══════════════\nPick ID: ${pickID}\nPick by: ${capperName}\n═══════════════\n\n══ STRICT CONFIDENTIALITY NOTICE ══\nAll OG Capper Bets Content is PRIVATE. Leaking, Stealing or Sharing ANY content is STRICTLY PROHIBITED. Violation = Termination. No Refund. No Appeal. Lifetime Ban.`;

      document.getElementById('results').innerHTML = `<div class='ticket'>${slip}</div>`;
    }
  </script>
</body>
</html>
