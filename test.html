<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watermark + Stats Composite with Cropping Fix</title>
  <style>
    body {
      background: #222;
      color: #eee;
      font-family: Arial, sans-serif;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #statsContainer {
      background: #333;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      width: 100%;
      margin-bottom: 20px;
      color: white;
      user-select: none;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #4caf50;
      color: white;
      transition: background 0.3s ease;
      margin-bottom: 20px;
    }
    button:hover {
      background: #45a049;
    }
    #resultImg {
      margin-top: 20px;
      border: 2px solid #ccc;
      border-radius: 8px;
      max-width: 90vw;
    }
  </style>
</head>
<body>
  <h1>Watermark + Stats Composite Image (With Bottom Crop Fix)</h1>

  <div id="statsContainer">
    <h2>Official Stats</h2>
    <p>Total Picks: 25</p>
    <p>Wins: 15 ‚úÖ</p>
    <p>Losses: 5 ‚ùå</p>
    <p>Push: 3 üü¶</p>
    <p>Pending: 2 ‚öôÔ∏è</p>
  </div>

  <button id="generateBtn">Generate Composite Image</button>

  <canvas id="canvas" style="display:none;"></canvas>
  <img id="resultImg" alt="Composite Image" />

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // Load image helper
    async function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Image load error: ' + src));
        img.src = src;
      });
    }

    // Crop transparent bottom whitespace from canvas
    function cropCanvasBottom(canvas) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;

      let lastVisibleRow = height;

      outer: for (let y = height - 1; y >= 0; y--) {
        for (let x = 0; x < width; x++) {
          const alpha = data[(y * width + x) * 4 + 3];
          if (alpha > 10) { // threshold for visible pixel
            lastVisibleRow = y + 1;
            break outer;
          }
        }
      }

      if (lastVisibleRow < height) {
        const croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = width;
        croppedCanvas.height = lastVisibleRow;
        const croppedCtx = croppedCanvas.getContext('2d');
        croppedCtx.drawImage(canvas, 0, 0, width, lastVisibleRow, 0, 0, width, lastVisibleRow);
        return croppedCanvas;
      }
      return canvas;
    }

    // Crop transparent bottom whitespace from image element (watermark)
    function cropImageBottom(image) {
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = image.width;
      tempCanvas.height = image.height;
      tempCtx.drawImage(image, 0, 0);

      const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const data = imageData.data;

      let lastVisibleRow = tempCanvas.height;

      outer: for (let y = tempCanvas.height - 1; y >= 0; y--) {
        for (let x = 0; x < tempCanvas.width; x++) {
          const alpha = data[(y * tempCanvas.width + x) * 4 + 3];
          if (alpha > 10) {
            lastVisibleRow = y + 1;
            break outer;
          }
        }
      }

      if (lastVisibleRow < tempCanvas.height) {
        const croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = tempCanvas.width;
        croppedCanvas.height = lastVisibleRow;
        const croppedCtx = croppedCanvas.getContext('2d');
        croppedCtx.drawImage(tempCanvas, 0, 0, tempCanvas.width, lastVisibleRow, 0, 0, tempCanvas.width, lastVisibleRow);
        return croppedCanvas;
      }
      return tempCanvas;
    }

    async function createComposite() {
      const watermarkUrl = 'https://capper.ogcapperbets.com/admin/images/blankWatermark.png';
      const statsContainer = document.getElementById('statsContainer');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      try {
        const watermarkImg = await loadImage(watermarkUrl);

        // Crop watermark bottom whitespace first
        const croppedWatermarkCanvas = cropImageBottom(watermarkImg);

        let statsCanvas = await html2canvas(statsContainer);
        statsCanvas = cropCanvasBottom(statsCanvas);

        const width = 600;

        // Use cropped watermark canvas natural size for aspect ratio
        const watermarkHeight = croppedWatermarkCanvas.height * (width / croppedWatermarkCanvas.width);

        const statsScale = width / statsCanvas.width;
        const statsHeight = statsCanvas.height * statsScale;

        canvas.width = width;
        canvas.height = watermarkHeight + statsHeight;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.drawImage(croppedWatermarkCanvas, 0, 0, width, watermarkHeight);

        ctx.drawImage(statsCanvas, 0, watermarkHeight, width, statsHeight);

        const resultImg = document.getElementById('resultImg');
        resultImg.src = canvas.toDataURL('image/png');
      } catch (err) {
        alert('Failed to create composite image: ' + err.message);
        console.error(err);
      }
    }

    document.getElementById('generateBtn').addEventListener('click', createComposite);
  </script>
</body>
</html>
