<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OG Capper Bets - Ticket</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    input {
      font-size: 1.2rem;
      padding: 0.5rem;
      width: 300px;
      margin-bottom: 1rem;
    }
    button {
      font-size: 1rem;
      padding: 0.5rem 1rem;
    }
    .ticket {
      background: #fff;
      padding: 1.5rem;
      margin-top: 2rem;
      border: 2px dashed #000;
      width: 350px;
    }
    .ticket-title {
      font-weight: bold;
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .error {
      color: red;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h2 style="color: white;">OG Capper Bets Ticket</h2>
  <input id="betInput" type="text" placeholder="e.g. Yankees ML 1.5u" />
  <button onclick="createTicket()">Generate Ticket</button>
  <div id="ticket"></div>
  <div id="error" class="error"></div>

  <script>
    const apiKey = "5b3cb0e7293b7d6217e6e99fa768fd0b";
    const sportsApi = "https://api.the-odds-api.com/v4/sports";
    const sportsDBKey = "1";
    const sportsDBUrl = "https://www.thesportsdb.com/api/v1/json/1";

    async function createTicket() {
      document.getElementById('ticket').innerHTML = "";
      document.getElementById('error').textContent = "";

      const input = document.getElementById('betInput').value.trim();
      const match = input.match(/^(.*?)\s+(ml)\s+(\d+(\.\d+)?)(u?)$/i);
      if (!match) {
        document.getElementById('error').textContent = "Invalid format. Try: Yankees ML 1.5u";
        return;
      }

      const queryTeam = match[1].toLowerCase();
      const units = match[3];
      const sportsRes = await fetch(`${sportsApi}/?apiKey=${apiKey}`);
      const sportsList = await sportsRes.json();

      for (let sport of sportsList) {
        try {
          const oddsRes = await fetch(`${sportsApi}/${sport.key}/odds/?apiKey=${apiKey}&regions=us&markets=h2h&oddsFormat=american`);
          if (!oddsRes.ok) continue;
          const games = await oddsRes.json();
          for (let game of games) {
            const home = game.home_team.toLowerCase();
            const away = game.away_team.toLowerCase();
            if (!home.includes(queryTeam) && !away.includes(queryTeam)) continue;

            const selected = home.includes(queryTeam) ? game.home_team : game.away_team;
            const opponent = home.includes(queryTeam) ? game.away_team : game.home_team;

            // Fetch venue/record
            const sportsDBRes = await fetch(`${sportsDBUrl}/searchteams.php?t=${encodeURIComponent(selected)}`);
            let venue = "Venue lookup failed";
            let record = "";
            if (sportsDBRes.ok) {
              const data = await sportsDBRes.json();
              const team = data.teams?.[0];
              if (team) {
                venue = `${team.strStadium} - ${team.strStadiumLocation} - ${team.strCountry}`;
                record = `${team.intWins || 0}-${team.intLosses || 0}-${team.intDraws || 0}`;
              }
            }

            // Odds handling
            let prices = [], draftKingsOdds = "N/A";
            for (let b of game.bookmakers) {
              const market = b.markets.find(m => m.key === "h2h");
              if (!market) continue;
              const outcome = market.outcomes.find(o => o.name.toLowerCase() === selected.toLowerCase());
              if (!outcome) continue;
              prices.push(outcome.price);
              if (b.key === "draftkings") draftKingsOdds = outcome.price > 0 ? "+" + outcome.price : outcome.price;
            }
            const avgOdds = prices.length ? (prices.reduce((a,b) => a+b,0)/prices.length).toFixed(0) : "N/A";

            // Output
            const ticketHTML = `
              <div class='ticket'>
                <div class='ticket-title'>üèÅ OG CAPPER BETS</div>
                <hr>
                <p><strong>BOOK:</strong> Avg Across Books</p>
                <p><strong>EVENT:</strong> ${game.home_team} vs ${game.away_team}</p>
                <p><strong>DATE:</strong> ${new Date(game.commence_time).toLocaleString()}</p>
                <hr>
                <p><strong>SELECTION:</strong> ${selected} ML</p>
                <p><strong>WAGER:</strong> ${units} unit(s)</p>
                <p><strong>ODDS:</strong> ${avgOdds > 0 ? "+" + avgOdds : avgOdds}</p>
                <p><strong>DRAFTKINGS:</strong> ${draftKingsOdds}</p>
                <hr>
                <p><strong>LOCATION:</strong><br>${venue}</p>
                <p><strong>RECORDS:</strong> ${record}</p>
                <hr>
                <p style='text-align:center;'>ALL SALES FINAL ‚Äì NO CANCELLATION</p>
              </div>
            `;
            document.getElementById('ticket').innerHTML = ticketHTML;
            return;
          }
        } catch(e) {
          continue;
        }
      }
      document.getElementById('error').textContent = "Game not found. Try a different team.";
    }
  </script>
</body>
</html>
