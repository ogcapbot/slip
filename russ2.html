<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OG Capper Bets - Field Discovery</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    input {
      font-size: 1.2rem;
      padding: 0.5rem;
      width: 300px;
      margin-bottom: 1rem;
    }
    button {
      font-size: 1rem;
      padding: 0.5rem 1rem;
    }
    .error {
      color: red;
      margin-top: 1rem;
    }
    pre {
      color: white;
      background-color: #222;
      padding: 1rem;
      margin-top: 2rem;
      max-width: 90%;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h2>OG Capper Bets - Field Discovery</h2>
  <input id="betInput" type="text" placeholder="e.g. Dodgers ML 1.5u" />
  <button onclick="createTicket()">Scan Fields</button>
  <div id="error" class="error"></div>
  <pre id="optionsOutput"></pre>

  <script>
    const apiKey = "5b3cb0e7293b7d6217e6e99fa768fd0b";

    function collectFields(obj, prefix = '', fields = new Set()) {
      if (Array.isArray(obj)) {
        obj.forEach((item) => collectFields(item, prefix, fields));
      } else if (typeof obj === 'object' && obj !== null) {
        for (const key in obj) {
          const path = prefix ? `${prefix}.${key}` : key;
          fields.add(path);
          collectFields(obj[key], path, fields);
        }
      }
      return fields;
    }

    async function createTicket() {
      document.getElementById('error').textContent = "";
      document.getElementById('optionsOutput').textContent = "";

      const input = document.getElementById('betInput').value.trim();
      const match = input.match(/^(.*?)\s+(ml)\s+(\d+(\.\d+)?)(u?)$/i);

      if (!match) {
        document.getElementById('error').textContent = "Invalid format. Use: TeamName ML 1.5u";
        return;
      }

      const teamQuery = match[1].toLowerCase();

      try {
        const sportsRes = await fetch(`https://api.the-odds-api.com/v4/sports/?apiKey=${apiKey}`);
        const sportsList = await sportsRes.json();
        const activeSports = sportsList.filter(s => s.active);

        let foundGame = null;

        for (const sport of activeSports) {
          const oddsRes = await fetch(
            `https://api.the-odds-api.com/v4/sports/${sport.key}/odds/?apiKey=${apiKey}&regions=us&markets=all&oddsFormat=american`
          );
          if (!oddsRes.ok) continue;

          const games = await oddsRes.json();
          foundGame = games.find(
            g =>
              g.home_team.toLowerCase().includes(teamQuery) ||
              g.away_team.toLowerCase().includes(teamQuery)
          );
          if (foundGame) break;
        }

        if (!foundGame) {
          document.getElementById('error').textContent = "Team not found across live games.";
          return;
        }

        const fields = Array.from(collectFields(foundGame)).sort();
        const outputText = "###\nAVAILABLE FIELDS\n###\n\n" + fields.map(f => `- ${f}`).join('\n');

        document.getElementById('optionsOutput').textContent = outputText;
      } catch (e) {
        document.getElementById('error').textContent = "Something went wrong. Check console.";
        console.error(e);
      }
    }
  </script>
</body>
</html>
