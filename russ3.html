<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>1OG Capper Bets - Ticket</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    input, button {
      font-size: 1.2rem;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    .ticket {
      background: #fff;
      padding: 1.5rem;
      margin-top: 2rem;
      border: 2px dashed #000;
      width: 350px;
    }
    .ticket-title {
      font-weight: bold;
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .error {
      color: red;
      margin-top: 1rem;
    }
    .details {
      background: #eee;
      font-size: 0.9rem;
      padding: 1rem;
      margin-top: 1rem;
      width: 350px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2 style="color: white;">OG Capper Bets Ticket</h2>
  <input id="betInput" type="text" placeholder="e.g. Louisville ML 1u" />
  <button onclick="createTicket()">Generate Ticket</button>
  <div id="ticket"></div>
  <div id="details"></div>
  <div id="error" class="error"></div>

  <script>
    const oddsKey = "5b3cb0e7293b7d6217e6e99fa768fd0b";
    const sportsDbKey = "123";

    async function createTicket() {
      document.getElementById("error").textContent = "";
      document.getElementById("ticket").innerHTML = "";
      document.getElementById("details").innerHTML = "";

      const input = document.getElementById("betInput").value.trim();
      const match = input.match(/^(.*?)\s+(ml)\s+(\d+(\.\d+)?)(u?)$/i);
      if (!match) {
        document.getElementById("error").textContent = "Invalid format. Try: Louisville ML 1.5u";
        return;
      }

      const teamQuery = match[1].toLowerCase();
      const units = match[3];

      let foundGame = null;
      let avgOdds = null;
      let dkOdds = null;

      const sportsListRes = await fetch(`https://api.the-odds-api.com/v4/sports/?apiKey=${oddsKey}`);
      const sportsList = sportsListRes.ok ? await sportsListRes.json() : [];

      for (const sport of sportsList.filter(s => s.active)) {
        const oddsURL = `https://api.the-odds-api.com/v4/sports/${sport.key}/odds/?apiKey=${oddsKey}&regions=us&markets=all&oddsFormat=american`;
        try {
          const res = await fetch(oddsURL);
          if (!res.ok) {
            if (res.status === 422) continue;
            throw new Error(`Fetch failed: ${res.status}`);
          }
          const games = await res.json();
          const game = games.find(g =>
            g.home_team?.toLowerCase().includes(teamQuery) ||
            g.away_team?.toLowerCase().includes(teamQuery)
          );
          if (!game) continue;

          const isHome = game.home_team.toLowerCase().includes(teamQuery);
          const team = isHome ? game.home_team : game.away_team;

          const allOdds = [];
          for (const book of game.bookmakers || []) {
            const h2h = book.markets?.find(m => m.key === "h2h");
            const outcome = h2h?.outcomes?.find(o => o.name.toLowerCase() === team.toLowerCase());
            if (outcome) {
              allOdds.push(outcome.price);
              if (book.title.toLowerCase().includes("draftkings")) {
                dkOdds = outcome.price;
              }
            }
          }

          if (allOdds.length > 0) {
            foundGame = game;
            avgOdds = Math.round(allOdds.reduce((a, b) => a + b, 0) / allOdds.length);
            break;
          }
        } catch (e) {
          console.warn("Odds API failed for", sport.key, e.message);
          continue;
        }
      }

      if (!foundGame) {
        document.getElementById("error").textContent = "Game not found or no odds available.";
        return;
      }

      const isHome = foundGame.home_team.toLowerCase().includes(teamQuery);
      const team = isHome ? foundGame.home_team : foundGame.away_team;
      const opponent = isHome ? foundGame.away_team : foundGame.home_team;
      const bookmaker = foundGame.bookmakers?.[0]?.title || "N/A";

      // SportsDB info
      let venue = "?", city = "?", state = "", country = "?";
      let win = "?", loss = "?", draw = "?";

      try {
        const res = await fetch(`https://www.thesportsdb.com/api/v1/json/${sportsDbKey}/searchteams.php?t=${encodeURIComponent(team)}`);
        const raw = await res.text();
        const teamData = raw ? JSON.parse(raw) : {};
        const teamInfo = teamData?.teams?.[0];

        if (teamInfo) {
          venue = teamInfo?.strStadium || "?";
          city = teamInfo?.strStadiumLocation || "?";
          state = teamInfo?.strState || "";
          country = teamInfo?.strCountry || "?";

          const leagueID = teamInfo.idLeague;
          const teamID = teamInfo.idTeam;
          if (leagueID && teamID) {
            const tableRes = await fetch(`https://www.thesportsdb.com/api/v1/json/${sportsDbKey}/lookuptable.php?l=${leagueID}&s=2024-2025`);
            const tableRaw = await tableRes.text();
            const standings = tableRaw ? JSON.parse(tableRaw) : {};
            const row = standings.table?.find(t => t.idTeam === teamID);
            if (row) {
              win = row.intWin ?? "?";
              loss = row.intLoss ?? "?";
              draw = row.intDraw ?? "?";
            }
          }
        }
      } catch (e) {
        console.warn("SportsDB lookup failed", e.message);
      }

      const ticketHTML = `
        <div class='ticket'>
          <div class='ticket-title'>üèÅ OG CAPPER BETS</div>
          <hr>
          <p><strong>BOOK:</strong> ${bookmaker}</p>
          <p><strong>EVENT:</strong> ${team} vs ${opponent}</p>
          <p><strong>DATE:</strong> ${new Date(foundGame.commence_time).toLocaleString()}</p>
          <hr>
          <p><strong>SELECTION:</strong> ${team} ML</p>
          <p><strong>WAGER:</strong> ${units} unit(s)</p>
          <p><strong>ODDS:</strong> Avg ${avgOdds > 0 ? '+' + avgOdds : avgOdds} | DK ${dkOdds !== null ? (dkOdds > 0 ? '+' + dkOdds : dkOdds) : 'N/A'}</p>
          <hr>
          <p style='text-align:center;'>ALL SALES FINAL ‚Äì NO CANCELLATION</p>
        </div>
      `;

      let optionsHTML = `\n###\nOPTIONS\n###\n`;
      for (const book of foundGame.bookmakers || []) {
        optionsHTML += `\nüìö Bookmaker: ${book.title}\n`;
        for (const market of book.markets || []) {
          optionsHTML += `‚Üí Market: ${market.key}\n`;
          for (const o of market.outcomes || []) {
            optionsHTML += `   ‚Ä¢ ${o.name}: ${o.price > 0 ? '+' + o.price : o.price}\n`;
          }
        }
      }

      const extraDetails = `
        <div class="details">
          <strong>VENUE:</strong> ${venue} - ${city}${state ? ", " + state : ""} - ${country}
          <br><strong>TEAM RECORD:</strong> ${win}-${loss}${draw !== "?" ? "-" + draw : ""}
          <pre>${optionsHTML}</pre>
        </div>
      `;

      document.getElementById("ticket").innerHTML = ticketHTML;
      document.getElementById("details").innerHTML = extraDetails;
    }
  </script>
</body>
</html>
