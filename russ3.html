<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OG Capper Betslip Generator</title>
  <style>
    body {
      font-family: monospace;
      background: #fff;
      color: #000;
      padding: 20px;
    }
    .ticket {
      border: 2px dashed #000;
      padding: 20px;
      width: 380px;
      position: relative;
      background: repeating-linear-gradient(
        -16deg,
        rgba(0, 0, 0, 0.025),
        rgba(0, 0, 0, 0.025) 20px,
        white 20px,
        white 40px
      );
    }
    .ticket::before {
      content: '';
      position: absolute;
      background-image: url('your-watermark.png'); /* Replace with actual watermark if needed */
      opacity: 0.25;
      transform: rotate(-16deg) scale(0.1);
      top: 0;
      left: 0;
      width: 1000px;
      height: 1000px;
      pointer-events: none;
    }
    .centered {
      text-align: center;
    }
    .small {
      font-size: 12px;
    }
    .bold {
      font-weight: bold;
    }
    .barcode {
      font-family: 'Courier New', Courier, monospace;
      font-size: 24px;
      letter-spacing: 4px;
      text-align: center;
      margin-top: 10px;
    }
    .line {
      border-top: 1px dashed black;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <input id="betInput" placeholder="e.g. tigers tt o3.5 1.5u" style="width: 300px;">
  <button onclick="createTicket()">Generate Ticket</button>

  <div id="output"></div>

  <script>
    const ODDS_API_KEY = '5b3cb0e7293b7d6217e6e99fa768fd0b';
    const SPORTS_DB_KEY = '1'; // public demo key

    const sportsList = [
      'baseball_mlb',
      'basketball_nba',
      'icehockey_nhl',
      'mma_mixed_martial_arts',
      'americanfootball_nfl',
      'soccer_usa_mls'
      // Add more as needed
    ];

    async function createTicket() {
      const bet = document.getElementById("betInput").value.trim();
      const output = document.getElementById("output");
      output.innerHTML = `<div class="ticket"><div class="centered">Generating...</div></div>`;

      for (let sport of sportsList) {
        try {
          const res = await fetch(`https://api.the-odds-api.com/v4/sports/${sport}/odds/?apiKey=${ODDS_API_KEY}&regions=us&markets=all&oddsFormat=american`);
          if (res.status === 422) continue;
          const games = await res.json();
          for (let game of games) {
            if (!game.teams) continue;
            const matchStr = `${game.teams[0]} vs ${game.teams[1]}`.toLowerCase();
            if (bet.toLowerCase().includes(game.teams[0].toLowerCase()) || bet.toLowerCase().includes(game.teams[1].toLowerCase())) {
              const team1 = game.teams[0];
              const team2 = game.teams[1];
              const date = new Date(game.commence_time).toLocaleString();
              const venueInfo = await fetchVenue(team1);
              const venue = venueInfo?.venue || 'Unknown';
              const location = `${venueInfo?.city || ''}, ${venueInfo?.country || ''}`.trim();
              const records = venueInfo?.record || '';

              const dk = game.bookmakers.find(b => b.key === 'draftkings');
              const dkOdds = dk ? dk.markets.map(m => `${m.key}: ${m.outcomes.map(o => o.name + ' ' + o.price).join(', ')}`).join('; ') : 'Unavailable';
              const avg = averageOdds(game.bookmakers);

              const wager = parseFloat(bet.match(/[\d.]+(?=u)/i)?.[0] || 1);
              const payout = avg ? Math.round(wager * (avg > 0 ? (avg / 100) + 1 : (100 / Math.abs(avg)) + 1)) : 0;

              const ticketHTML = `
                <div class="ticket">
                  <div class="centered bold">OG CAPPER BETS</div>
                  <div class="centered small">ogcapperbets.com</div>
                  <div class="line"></div>
                  <div><strong>Match:</strong> ${team1} vs ${team2}</div>
                  <div><strong>Kickoff:</strong> ${date}</div>
                  <div><strong>Location:</strong> ${venue} - ${location}</div>
                  <div><strong>Records:</strong> ${records}</div>
                  <div class="line"></div>
                  <div><strong>Bet:</strong> ${bet.toUpperCase()}</div>
                  <div><strong>Wager:</strong> $${wager * 100}</div>
                  <div><strong>Potential Payout:</strong> $${payout}</div>
                  <div><strong>DraftKings Odds:</strong> ${dkOdds}</div>
                  <div><strong>Average Odds:</strong> ${avg}</div>
                  <div class="line"></div>
                  <div class="centered small">Ticket ID: ${Date.now()}</div>
                  <div class="centered small">${new Date().toLocaleString()}</div>
                  <div class="barcode">|| ||| || |||| | |||</div>
                  <div class="centered small">FOR ENTERTAINMENT ONLY</div>
                  <div class="centered small">ALL SALES FINAL</div>
                  <div class="centered small">NO CASH VALUE</div>
                </div>
              `;
              output.innerHTML = ticketHTML;
              return;
            }
          }
        } catch (e) {
          console.warn(`${sport} skipped`, e);
          continue;
        }
      }

      output.innerHTML = `<div class="ticket"><div class="centered">No matching event found.</div></div>`;
    }

    async function fetchVenue(team) {
      try {
        const res = await fetch(`https://www.thesportsdb.com/api/v1/json/${SPORTS_DB_KEY}/searchteams.php?t=${encodeURIComponent(team)}`);
        const data = await res.json();
        const teamInfo = data.teams?.[0];
        return {
          venue: teamInfo?.strStadium || '',
          city: teamInfo?.strStadiumLocation || '',
          country: teamInfo?.strCountry || '',
          record: teamInfo?.intWins && teamInfo?.intLosses
            ? `${teamInfo.intWins}-${teamInfo.intLosses}-${teamInfo.intDraws || 0}`
            : 'N/A'
        };
      } catch {
        return null;
      }
    }

    function averageOdds(bookmakers) {
      const prices = [];
      for (let book of bookmakers) {
        for (let market of book.markets) {
          for (let outcome of market.outcomes) {
            if (typeof outcome.price === 'number') prices.push(outcome.price);
          }
        }
      }
      if (prices.length === 0) return null;
      const sum = prices.reduce((a, b) => a + b, 0);
      return Math.round(sum / prices.length);
    }
  </script>
</body>
</html>
