<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OG Capper Bets - Official Pick Image Creator v7.25</title>

  <link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Oswald', sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }

    input[type="number"],
    input[type="text"],
    select,
    textarea {
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      margin: 0 auto 12px;
      display: block;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      margin: 0 auto 12px;
      display: block;
      padding: 12px;
      font-size: 16px;
      background-color: #2a9fd6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    /* New style: Increase height of parlay pick buttons */
    .pick-type-btn {
      padding-top: 22px;
      padding-bottom: 22px;
    }

    button:hover {
      background-color: #2179a5;
    }

    .hidden {
      display: none;
    }

    .error {
      color: red;
      font-size: 14px;
      margin-top: 10px;
    }

    #loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #2a9fd6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #confirmOutput {
      white-space: pre-wrap;
      font-family: monospace;
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      resize: none;
      overflow: hidden;
      min-height: 200px;
      height: auto;
    }

    #resetWrapper {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      height: 0;
    }

    #resetBtn {
      position: absolute;
      top: -35px;
      right: 0;
      font-size: 14px;
      padding: 4px 12px;
      background-color: #2a9fd6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      height: auto;
      width: auto;
      white-space: nowrap;
    }

    #copyBtn {
      margin-bottom: 10px;
    }

    #loginNotice {
      margin-bottom: 20px;
      font-weight: bold;
      color: gray;
      text-align: center;
    }

    #inputLabel {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    #gameSuggestion {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      background: #fff;
      margin-bottom: 20px;
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }

    #gameSuggestion p {
      margin: 6px 0;
    }

    #gameSuggestion strong {
      display: block;
      margin-bottom: 10px;
      font-size: 16px;
    }

    #gameTable,
    #sportDropdown {
      display: none;
    }

    #sports-screen {
      position: relative;
      overflow: hidden;
    }

    #imageLoader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #2a9fd6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    #imageLoaderText {
      font-size: 16px;
      font-weight: bold;
      color: #2a9fd6;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.2; }
    }

    .hypeOutputBlock {
      border: 1px solid #2a9fd6;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 6px;
      background-color: #eaf6ff;
      user-select: none;
    }
    .hypeOutputBlock:focus {
      outline: 2px solid #2179a5;
      outline-offset: 2px;
    }

    /* NEW styles for Post Title and Post Desc textboxes */
    .copyTextbox {
      font-family: 'Oswald', sans-serif !important;
      font-size: 11px !important;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      padding: 6px 10px;
      margin: 8px auto;
      border-radius: 6px;
      border: 1px solid #2a9fd6;
      background-color: #f0f8ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      user-select: all;
    }

    .copyTextbox:focus {
      outline: 2px solid #2179a5;
      outline-offset: 2px;
    }

    /* Titles above textboxes */
    .copyTextboxLabel {
      color: #666;
      font-size: 14px;
      margin: 12px 0 4px 0;
      font-weight: 600;
      font-family: 'Oswald', sans-serif;
      user-select: none;
    }

    /* New Pick Type Screen container */
    #pickTypeScreen {
      max-width: 400px;
      margin: 20px auto;
      text-align: center;
    }

    #pickTypeScreen h2 {
      margin-bottom: 20px;
      font-weight: 700;
      color: #2a9fd6;
    }
  </style>
</head>
<body>

  <div class="container" id="access-screen">
    <div id="globalHeader" style="text-align: center; padding: 20px 0 10px;">
      <h3 style="margin: 0;">OG Capper Bets – Official Pick Image Creator v7.25</h3>
      <h5 style="margin: 0; color: red;">Official Use Only</h5>
    </div>

    <label style="color: #666; font-size: 14px; margin-bottom: 10px; display: block;">Enter Access Code</label>
    <input
      type="text"
      id="accessCode"
      placeholder="Enter Code Here"
      pattern="[0-9]*"
      inputmode="numeric"
      maxlength="10"
      style="width: 100%; max-width: 400px; box-sizing: border-box; display: block; margin: 0 auto 12px; padding: 12px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc;"
    />
    <button id="accessBtn" onclick="validateAccess()">Submit</button>
    <div class="error" id="error"></div>
  </div>

  <!-- NEW Pick Type Selection Screen - initially hidden -->
  <div class="container hidden" id="pickTypeScreen">
    <h2>Please Select Your Pick Type</h2>
    <button class="pick-type-btn" id="btnStraightPick">Straight Pick</button>
    <button class="pick-type-btn" id="btnUpTo5Parlay">Up to 5 Parlay Picks</button>
    <button class="pick-type-btn" id="btn6to15Parlay">6 to 15 Parlay Picks</button>
  </div>

  <div class="container hidden" id="sports-screen">
    <div id="loader"></div>
    <div id="loadingMsg" style="text-align:center; font-weight:bold;">Loading Games...</div>

    <div id="loggedInInfo" class="hidden">
      <div id="globalHeader" style="text-align: center; padding: 20px 0 10px;">
        <h3 style="margin: 0;">OG Capper Bets – Official Pick Image Creator v7.25</h3>
        <h5 style="margin: 0; color: red;">Official Use Only</h5>
        <h5 id="loginNotice"></h5>
      </div>

      <div id="resetWrapper">
        <button id="resetBtn" onclick="resetSearch()">Reset</button>
      </div>

      <!-- Added container for Post Title and Post Desc textboxes here -->
      <div id="postTitleDescContainer" style="margin-top: 10px; max-width: 400px;">
        <!-- These inputs and labels will be created dynamically -->
      </div>

      <div id="gameSuggestion" class="hidden"></div>
    </div>

    <div id="inputLabel">Enter Team Name: (e.g. 'Chicago Cubs' or 'Cubs')</div>
    <input type="text" id="teamSearch" placeholder="Must be at least 3 Characters" />
    <button id="searchBtn" onclick="searchGames()">Submit</button>
    <div class="error" id="searchError"></div>

    <div id="customInputSection" class="hidden"></div>

    <div id="unitDropdownSection" class="hidden">
      <label for="unitDropdown" style="color:#666;font-size:14px;margin-bottom:5px;display:block;">
        Select Unit(s):
      </label>
      <select id="unitDropdown"></select>
      <div class="error" id="unitDropdownError"></div>
    </div>

    <div id="notesChoiceSection" class="hidden">
      <label style="color: #666; font-size: 14px; margin-bottom: 10px; display: block;">
        Do You Want to Include any Comments/Notes?
      </label>
      <button id="yesNoteBtn">Yes, Enter Comment/Note</button>
      <button id="noNoteBtn">No, Proceed to Next Step</button>
    </div>

    <div id="notesInputSection" class="hidden" style="margin-top: 20px;">
      <div id="notesHeaderRow" style="display: none; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <label for="notesInput" style="color: #666; font-size: 14px;">
          Enter Your Comment/Note Below:
        </label>
        <div id="charCount" style="color: #666; font-size: 14px;">
          Remaining: 100
        </div>
      </div>

      <textarea
        id="notesInput"
        rows="2"
        maxlength="100"
        placeholder="Enter Comment/Note Here"
        style="font-family: 'Oswald', Arial, sans-serif; font-size: 14px; width: 100%; box-sizing: border-box;"
      ></textarea>

      <button id="submitNoteBtn" class="hidden">Submit</button>
    </div>

    <!-- New Hype Phrase Step -->
    <div id="hypePhraseStep" class="hidden" style="margin-top: 20px;">
      <label for="hypeASelect" style="color:#666; font-size:14px; margin-bottom:5px; display:block;">
        Select Type of Hype Phrase:
      </label>
      <select id="hypeASelect"></select>

      <label for="hypeBSelect" style="color:#666; font-size:14px; margin-bottom:5px; display:block; margin-top: 15px;">
        Select Energy of Hype Phrase:
      </label>
      <select id="hypeBSelect" disabled></select>

      <div id="hypePhraseOutputs" style="margin-top: 15px;"></div>
    </div>

    <pre id="confirmOutput" class="hidden"></pre>
  </div>

  <script>
    const BASE_URL = "https://script.google.com/macros/s/AKfycbzbNo6fcQsDvPSlsaC9y1U3NsO214vuS-7a6EwhtFXi-sH3fHQaJawg6LDehcf4TCepkA/exec";
    let capperInfo = [], allData = {}, currentMatchIndex = 0, matches = [], selectedMatch = null, capperName = "";

    // Added variables to track pick type and parlay picks in memory
    let pickType = "straight"; // "straight", "upTo5", "6to15"
    let parlayPicks = []; // array to store picks as objects
    let currentPickNumber = 1;

    window.onload = async () => {
      try {
        const res = await fetch(BASE_URL + "?action=capperOnly");
        const result = await res.json();
        capperInfo = result.capperInfo;

        document.getElementById("accessCode").disabled = false;
        document.getElementById("accessBtn").disabled = false;
        document.getElementById("accessCode").focus();
      } catch {
        document.getElementById("error").textContent = "Failed to load access codes.";
      }
    };

    function validateAccess() {
      const code = document.getElementById("accessCode").value.trim();
      const match = capperInfo.find(row => row["Access Code"] == code);
      if (code.length < 4 || code.length > 10 || !match) {
        document.getElementById("error").textContent = "Access Code Invalid. Please Enter a Valid Access Code.";
        return;
      }

      capperName = match["Display Name"];
      document.getElementById("access-screen").classList.add("hidden");

      // Show Pick Type Screen instead of sports screen immediately
      document.getElementById("pickTypeScreen").classList.remove("hidden");

      // Hide everything in sports screen for now
      const sportsScreen = document.getElementById("sports-screen");
      Array.from(sportsScreen.children).forEach(el => el.style.display = "none");

      // Setup Pick Type button events
      setupPickTypeButtons();
    }

    function setupPickTypeButtons() {
      document.getElementById("btnStraightPick").onclick = () => {
        pickType = "straight";
        parlayPicks = [];
        currentPickNumber = 1;

        // Hide pick type screen, show sports screen, show normal initial UI
        document.getElementById("pickTypeScreen").classList.add("hidden");
        showSportsScreenInitial();
      };

      document.getElementById("btnUpTo5Parlay").onclick = () => {
        pickType = "upTo5";
        parlayPicks = [];
        currentPickNumber = 1;

        document.getElementById("pickTypeScreen").classList.add("hidden");
        showSportsScreenInitial();
      };

      document.getElementById("btn6to15Parlay").onclick = () => {
        pickType = "6to15";
        parlayPicks = [];
        currentPickNumber = 1;

        document.getElementById("pickTypeScreen").classList.add("hidden");
        showSportsScreenInitial();
      };
    }

    // Show the sports screen initial elements, after pick type selection
    function showSportsScreenInitial() {
      const sportsScreen = document.getElementById("sports-screen");

      // Show all children except loader and loadingMsg - reset visibility
      Array.from(sportsScreen.children).forEach(el => {
        if (el.id !== "loader" && el.id !== "loadingMsg") {
          el.style.display = "";
        }
      });

      // Show loggedInInfo container
      document.getElementById("loggedInInfo").classList.remove("hidden");

      // Set login notice
      document.getElementById("loginNotice").textContent = `Logged in as: ${capperName}`;

      // Show main inputs: label, teamSearch, searchBtn
      document.getElementById("inputLabel").classList.remove("hidden");
      document.getElementById("inputLabel").style.display = "";
      document.getElementById("teamSearch").classList.remove("hidden");
      document.getElementById("teamSearch").style.display = "";
      document.getElementById("teamSearch").value = "";
      document.getElementById("teamSearch").focus();
      document.getElementById("searchBtn").classList.remove("hidden");
      document.getElementById("searchBtn").style.display = "";

      // Hide other optional sections just in case
      const optionalSections = [
        "gameSuggestion",
        "customInputSection",
        "unitDropdownSection",
        "notesChoiceSection",
        "notesInputSection",
        "confirmOutput",
        "submitNoteBtn",
        "hypePhraseStep"
      ];
      optionalSections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      });
    }

    // Override the normal useThisGame function for parlay picks flow
    function useThisGame() {
      document.getElementById("gameSuggestion").classList.add("hidden");

      document.getElementById("inputLabel").classList.add("hidden");
      document.getElementById("teamSearch").classList.add("hidden");
      document.getElementById("searchBtn").classList.add("hidden");

      document.getElementById("customInputSection").classList.remove("hidden");
      buildWagerDropdownForPick();
    }

    // Build wager dropdown with extra buttons for parlay picks after wager and unit input
    function buildWagerDropdownForPick() {
      const wagerData = (allData.wagers || []).filter(row => row.active_status === 'active');
      const inputDiv = document.getElementById("customInputSection");

      inputDiv.innerHTML = `
        <label for="wagerDropdown" style="color:#666;font-size:14px;margin-bottom:5px;display:block;">
          Select Wager Type Below:
        </label>
        <select id="wagerDropdown"></select>
        <div class="error" id="wagerError"></div>
      `;

      const dropdown = document.getElementById("wagerDropdown");

      const defaultOpt = document.createElement("option");
      defaultOpt.textContent = "Select Item Below";
      defaultOpt.disabled = true;
      defaultOpt.selected = true;
      dropdown.appendChild(defaultOpt);

      const isOverride = !!window.overrideTeamName;

      let filteredWagerData = wagerData;

      if (!isOverride) {
        const detectedSport = selectedMatch?.["League (Group)"]?.trim() || "";
        filteredWagerData = wagerData.filter(row => {
          const rowSport = (row.Sport || "").trim();
          return !rowSport || rowSport.toLowerCase() === detectedSport.toLowerCase();
        });
      }

      filteredWagerData.forEach(row => {
        const opt = document.createElement("option");
        opt.textContent = row.wager_label_template;
        opt.value = row.wager_label_template;
        opt.dataset.requiresNumber = row.pick_desc_template.includes("[[NUM]]") ? "yes" : "no";
        dropdown.appendChild(opt);
      });

      const otherOpt = document.createElement("option");
      otherOpt.textContent = "Other (Manual Entry Override)";
      otherOpt.value = "__other";
      dropdown.appendChild(otherOpt);

      dropdown.addEventListener("change", () => {
        const selected = dropdown.value;
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        const requiresNumber = selectedOption.dataset.requiresNumber === "yes";

        if (selected === "__other") {
          inputDiv.innerHTML = `
            <label for="wagerType" style="color:#666;font-size:14px;margin-bottom:5px;display:block;">
              Enter Wager Type (e.g. 'ML' or 'F5')
            </label>
            <input type="text" id="wagerType" />
            <button id="submitWagerBtn">Submit</button>
            <div class="error" id="wagerError"></div>
          `;

          document.getElementById("submitWagerBtn").onclick = () => {
            submitWagerTypeForPick();
          };

          document.getElementById("unitDropdownSection").classList.add("hidden");
        } else {
          if (requiresNumber && selected.includes("[[NUM]]")) {
            showNumInputScreenForPick(selected);
          } else {
            // Hide customInputSection after selection (for now)
            // then show unit dropdown section
            document.getElementById("customInputSection").classList.add("hidden");
            buildUnitDropdownForPick();
            document.getElementById("unitDropdownSection").classList.remove("hidden");
          }
        }
      });
    }

    function submitWagerTypeForPick() {
      const wagerInput = document.getElementById("wagerType");
      const wager = wagerInput.value.trim();
      const errorBox = document.getElementById("wagerError");

      const valid = /^[A-Za-z0-9 .]+$/.test(wager) && wager.length > 0;
      if (!valid) {
        errorBox.textContent = "The information entered does not conform to the standard or was left blank. Please check your entry, and try again.";
        return;
      }

      errorBox.textContent = "";

      document.getElementById("customInputSection").classList.add("hidden");
      document.getElementById("unitDropdownSection").classList.remove("hidden");

      buildUnitDropdownForPick();
      document.getElementById("unitDropdown").focus();
    }

    function showNumInputScreenForPick(wagerTemplate) {
      const inputDiv = document.getElementById("customInputSection");
      inputDiv.innerHTML = `
        <label for="numInput" style="color:#666;font-size:14px;margin-bottom:5px;display:block;" id="numInputLabel"></label>
        <input type="number" id="numInput" step="0.5" min="0.5" max="300" inputmode="decimal" pattern="^(0\\.5|[1-9][0-9]*([.]5)?)$" />
        <div class="error" id="numInputError"></div>
        <button id="numSubmitBtn">Submit</button>
      `;

      const label = document.getElementById("numInputLabel");
      const previousVal = wagerTemplate;
      label.textContent = `Enter the amount for [[NUM]] (${previousVal})`;

      const numInput = document.getElementById("numInput");

      setTimeout(() => {
        numInput.focus();
      }, 100);

      // Validate increments
      numInput.addEventListener("input", () => {
        let val = numInput.value;
        const errorDiv = document.getElementById("numInputError");
        errorDiv.textContent = "";

        if (val === "") return;

        const num = parseFloat(val);
        if (isNaN(num) || num < 0.5 || num > 300 || (num * 2) % 1 !== 0) {
          errorDiv.textContent = "Please enter a positive number up to 300 in 0.5 increments (e.g. 0.5, 1, 1.5).";
        }
      });

      document.getElementById("numSubmitBtn").onclick = () => {
        const val = numInput.value.trim();
        const errorDiv = document.getElementById("numInputError");

        if (!val) {
          errorDiv.textContent = "Please enter a value.";
          numInput.focus();
          return;
        }
        const num = parseFloat(val);
        if (isNaN(num) || num < 0.5 || num > 300 || (num * 2) % 1 !== 0) {
          errorDiv.textContent = "Please enter a positive number up to 300 in 0.5 increments (e.g. 0.5, 1, 1.5).";
          numInput.focus();
          return;
        }

        window.currentWagerWithNum = wagerTemplate.replace(/\[\[NUM\]\]/g, val);

        errorDiv.textContent = "";
        document.getElementById("customInputSection").classList.add("hidden");
        buildUnitDropdownForPick();
        document.getElementById("unitDropdownSection").classList.remove("hidden");
        document.getElementById("unitDropdown").focus();
      };
    }

    function buildUnitDropdownForPick() {
      const unitData = allData.units || [];

      const dropdown = document.getElementById("unitDropdown");
      const section = document.getElementById("unitDropdownSection");

      dropdown.innerHTML = "";

      const defaultOpt = document.createElement("option");
      defaultOpt.textContent = "Select Unit Amount...";
      defaultOpt.disabled = true;
      defaultOpt.selected = true;
      dropdown.appendChild(defaultOpt);

      unitData.forEach(row => {
        const opt = document.createElement("option");
        opt.textContent = row.display_unit;
        opt.value = row.display_unit;
        dropdown.appendChild(opt);
      });

      if (section.classList.contains("hidden")) {
        section.classList.remove("hidden");
      }
    }

    // Override submitUnitAmount to handle parlay picks logic
    function submitUnitAmount(bypass = false) {
      const dropdown = document.getElementById("unitDropdown");
      const input = dropdown ? dropdown.value : "";
      const errorDiv = document.getElementById("unitDropdownError");

      if (!input || input === "Select Unit(s)") {
        errorDiv.textContent = "Please select a valid unit amount.";
        return;
      }

      errorDiv.textContent = "";

      if (pickType === "straight") {
        // Normal flow for straight pick
        document.getElementById("unitDropdownSection").classList.add("hidden");
        document.getElementById("notesChoiceSection").classList.remove("hidden");
      } else {
        // Parlay picks flow
        document.getElementById("unitDropdownSection").classList.add("hidden");

        // Capture current pick data
        let wagerRaw = "";
        const wagerInput = document.getElementById("wagerType");
        const wagerDropdown = document.getElementById("wagerDropdown");

        if (window.currentWagerWithNum) {
          wagerRaw = window.currentWagerWithNum;
        } else if (wagerInput) {
          wagerRaw = wagerInput.value.trim();
        } else if (wagerDropdown) {
          wagerRaw = wagerDropdown.value.trim();
        }

        // Save current pick info in parlayPicks array
        // Copy selectedMatch and replace keys with P1, P2, ... suffixes
        let pickObj = {};

        // Deep copy selectedMatch with suffix
        for (const key in selectedMatch) {
          if (Object.hasOwnProperty.call(selectedMatch, key)) {
            pickObj[`${key}P${currentPickNumber}`] = selectedMatch[key];
          }
        }

        // Add wager and units
        pickObj[`WagerP${currentPickNumber}`] = wagerRaw;
        pickObj[`UnitP${currentPickNumber}`] = input;

        parlayPicks.push(pickObj);

        // Reset wager inputs for next pick
        window.currentWagerWithNum = null;
        document.getElementById("wagerType")?.value && (document.getElementById("wagerType").value = "");
        const wagerDropdownElem = document.getElementById("wagerDropdown");
        if (wagerDropdownElem) wagerDropdownElem.selectedIndex = 0;

        currentPickNumber++;

        // Reset teamSearch and gameSuggestion for next pick
        resetPickInputsForNextPick();

        // Decide if show add another pick or submit button
        if (pickType === "upTo5") {
          if (currentPickNumber <= 5) {
            showAddAnotherPickButtons(false); // user can add or submit
          } else {
            // Max picks reached
            showSubmitOnlyButton();
          }
        } else if (pickType === "6to15") {
          if (currentPickNumber <= 5) {
            // Force user to add another pick, no submit yet
            showAddAnotherPickButtons(true); // hide submit button
          } else if (currentPickNumber <= 15) {
            showAddAnotherPickButtons(false); // allow add or submit
          } else {
            // Max picks reached
            showSubmitOnlyButton();
          }
        }
      }
    }

    // Show buttons after wager/unit input for parlay picks
    function showAddAnotherPickButtons(forceAddOnly) {
      // Hide notesChoiceSection
      document.getElementById("notesChoiceSection").classList.add("hidden");

      const customSection = document.getElementById("customInputSection");
      const unitSection = document.getElementById("unitDropdownSection");
      const notesSection = document.getElementById("notesChoiceSection");

      // Clear any existing buttons in customInputSection and unitDropdownSection to avoid confusion
      // (We keep those hidden anyway, so safe)

      // Show a new div with "Add Another Parlay Pick" and "Submit" buttons
      const pickActionDivId = "parlayPickActionsDiv";
      let actionDiv = document.getElementById(pickActionDivId);
      if (!actionDiv) {
        actionDiv = document.createElement("div");
        actionDiv.id = pickActionDivId;
        actionDiv.style.marginTop = "10px";
        actionDiv.style.maxWidth = "400px";
        actionDiv.style.marginLeft = "auto";
        actionDiv.style.marginRight = "auto";
        actionDiv.style.display = "flex";
        actionDiv.style.flexDirection = "column";
        actionDiv.style.gap = "10px";
        document.getElementById("sports-screen").insertBefore(actionDiv, notesSection);
      }
      actionDiv.innerHTML = "";

      // Add "Add Another Parlay Pick" button
      const addBtn = document.createElement("button");
      addBtn.textContent = "Add Another Parlay Pick";
      addBtn.style.backgroundColor = "#2a9fd6";
      addBtn.style.color = "white";
      addBtn.style.border = "none";
      addBtn.style.borderRadius = "6px";
      addBtn.style.cursor = "pointer";
      addBtn.style.padding = "12px";
      addBtn.style.fontSize = "16px";
      addBtn.onclick = () => {
        // Hide this div and go back to team/game input for next pick
        actionDiv.style.display = "none";

        // Show team input
        document.getElementById("inputLabel").classList.remove("hidden");
        document.getElementById("inputLabel").style.display = "";
        document.getElementById("teamSearch").classList.remove("hidden");
        document.getElementById("teamSearch").style.display = "";
        document.getElementById("teamSearch").value = "";
        document.getElementById("teamSearch").focus();
        document.getElementById("searchBtn").classList.remove("hidden");
        document.getElementById("searchBtn").style.display = "";

        // Reset gameSuggestion and others
        document.getElementById("gameSuggestion").classList.add("hidden");
        selectedMatch = null;
        matches = [];
        currentMatchIndex = 0;
      };
      actionDiv.appendChild(addBtn);

      if (!forceAddOnly) {
        // Add Submit button for parlay picks
        const submitBtn = document.createElement("button");
        submitBtn.textContent = "Submit Parlay Picks";
        submitBtn.style.backgroundColor = "#2a9fd6";
        submitBtn.style.color = "white";
        submitBtn.style.border = "none";
        submitBtn.style.borderRadius = "6px";
        submitBtn.style.cursor = "pointer";
        submitBtn.style.padding = "12px";
        submitBtn.style.fontSize = "16px";
        submitBtn.onclick = () => {
          // Remove action div
          actionDiv.style.display = "none";

          // Proceed to Unit Selection screen for parlay picks flow (or final process)
          proceedAfterParlayPicks();
        };
        actionDiv.appendChild(submitBtn);
      } else {
        // Hide Submit button if forceAddOnly = true (for 6to15 picks first 5 picks)
        // So only "Add Another Parlay Pick" button visible and Submit hidden
      }

      actionDiv.style.display = "flex";
    }

    // Show only Submit button (max picks reached)
    function showSubmitOnlyButton() {
      // Hide notesChoiceSection
      document.getElementById("notesChoiceSection").classList.add("hidden");

      const pickActionDivId = "parlayPickActionsDiv";
      let actionDiv = document.getElementById(pickActionDivId);
      if (!actionDiv) {
        actionDiv = document.createElement("div");
        actionDiv.id = pickActionDivId;
        actionDiv.style.marginTop = "10px";
        actionDiv.style.maxWidth = "400px";
        actionDiv.style.marginLeft = "auto";
        actionDiv.style.marginRight = "auto";
        actionDiv.style.display = "flex";
        actionDiv.style.flexDirection = "column";
        actionDiv.style.gap = "10px";
        document.getElementById("sports-screen").insertBefore(actionDiv, document.getElementById("notesChoiceSection"));
      }
      actionDiv.innerHTML = "";

      const submitBtn = document.createElement("button");
      submitBtn.textContent = "Submit Parlay Picks";
      submitBtn.style.backgroundColor = "#2a9fd6";
      submitBtn.style.color = "white";
      submitBtn.style.border = "none";
      submitBtn.style.borderRadius = "6px";
      submitBtn.style.cursor = "pointer";
      submitBtn.style.padding = "12px";
      submitBtn.style.fontSize = "16px";
      submitBtn.onclick = () => {
        actionDiv.style.display = "none";
        proceedAfterParlayPicks();
      };
      actionDiv.appendChild(submitBtn);

      actionDiv.style.display = "flex";
    }

    // Reset inputs and states for next pick after adding a parlay pick
    function resetPickInputsForNextPick() {
      // Hide customInputSection and unitDropdownSection
      document.getElementById("customInputSection").classList.add("hidden");
      document.getElementById("unitDropdownSection").classList.add("hidden");

      // Reset wagerType and wagerDropdown inputs
      if (document.getElementById("wagerType")) document.getElementById("wagerType").value = "";
      if (document.getElementById("wagerDropdown")) document.getElementById("wagerDropdown").selectedIndex = 0;

      // Show team/game selection inputs again
      document.getElementById("inputLabel").classList.remove("hidden");
      document.getElementById("inputLabel").style.display = "";
      document.getElementById("teamSearch").classList.remove("hidden");
      document.getElementById("teamSearch").style.display = "";
      document.getElementById("teamSearch").value = "";
      document.getElementById("teamSearch").focus();
      document.getElementById("searchBtn").classList.remove("hidden");
      document.getElementById("searchBtn").style.display = "";

      // Hide gameSuggestion, customInputSection, unitDropdownSection
      document.getElementById("gameSuggestion").classList.add("hidden");
      document.getElementById("customInputSection").classList.add("hidden");
      document.getElementById("unitDropdownSection").classList.add("hidden");

      // Clear any errors
      document.getElementById("wagerError")?.textContent = "";
      document.getElementById("unitDropdownError")?.textContent = "";
      document.getElementById("numInputError")?.textContent = "";
      document.getElementById("searchError")?.textContent = "";

      selectedMatch = null;
      matches = [];
      currentMatchIndex = 0;
    }

    // When user clicks "Submit Parlay Picks" after 1-5 or 6-15 picks
    function proceedAfterParlayPicks() {
      // We now have parlayPicks[] array with pick objects containing all info
      // Store parlay picks globally for further use if needed
      window.parlayPicksData = parlayPicks;

      // Show notesChoiceSection for parlay picks (or could skip notes? Here same flow)
      document.getElementById("notesChoiceSection").classList.remove("hidden");
    }

    // Original searchGames function unchanged
    function searchGames() {
      const input = document.getElementById("teamSearch").value.trim().toLowerCase();
      const rows = allData.gameCache || [];
      const resultSet = [];

      for (let row of rows) {
        const home = (row["Home Team"] || "").toLowerCase();
        const away = (row["Away Team"] || "").toLowerCase();
        const date = new Date(row["Commence Time (UTC)"]);

        if (input === home || input === away ||
          home.split(" ").includes(input) || away.split(" ").includes(input) ||
          (input.length >= 3 && (home.includes(input) || away.includes(input)))) {
          resultSet.push({ row, date });
        }
      }

      matches = resultSet.sort((a, b) => a.date - b.date);
      currentMatchIndex = 0;

      if (matches.length > 0) {
        const input = document.getElementById("teamSearch");
        const label = document.getElementById("inputLabel");
        const button = document.getElementById("searchBtn");

        input.classList.add("hidden");
        label.classList.add("hidden");
        button.classList.add("hidden");

        input.style.display = "none";
        label.style.display = "none";
        button.style.display = "none";
      }

      showGameOption();
    }

    function showGameOption() {
      const container = document.getElementById("gameSuggestion");
      const searchError = document.getElementById("searchError");

      container.classList.add("hidden");
      searchError.textContent = "";

      if (matches.length === 0) {
        const teamInputRaw = document.getElementById("teamSearch").value.trim();

        searchError.innerHTML = `
          <div style="color: red; font-weight: bold;">
            No matching games found for '${teamInputRaw}'.
            <br>
            Please be more specific and try again.
          </div>

          <h3 style="margin-top: 10px; color: black;">Manual Override Option:</h3>
          <p style="color: black;">
            If you have tried being more specific and checked for spelling errors and are still receiving 0 results,
            you can manually override the lookup function and use your input value of <strong>'${teamInputRaw}'</strong> instead.
            <br><br>
            Please double check the spelling and use the complete name before Overriding.
          </p>
          <h3 style="color: black;">Your Input Value: '${teamInputRaw}'</h3>
          <button id="overrideBtn" style="margin-top: 10px; padding: 10px; background-color: #d9534f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
            Override – Use Value Above
          </button>
        `;

        document.getElementById("overrideBtn").onclick = function () {
          const overrideValue = teamInputRaw;
          window.overrideTeamName = overrideValue;
          selectedMatch = {
            "League (Group)": "Unavailable",
            "Sport Name": "Unavailable",
            "Home Team": "Unavailable",
            "Away Team": "Unavailable",
            "Commence Time (UTC)": null
          };

          const input = document.getElementById("teamSearch");
          const label = document.getElementById("inputLabel");
          const button = document.getElementById("searchBtn");

          input.classList.add("hidden");
          label.classList.add("hidden");
          button.classList.add("hidden");

          input.style.display = "none";
          label.style.display = "none";
          button.style.display = "none";

          document.getElementById("searchError").innerHTML = "";
          document.getElementById("gameSuggestion").classList.add("hidden");

          document.getElementById("customInputSection").classList.remove("hidden");
          buildWagerDropdownForPick();
        };

        return;
      }

      if (currentMatchIndex >= matches.length) {
        searchError.textContent = "No more matches. Please be more specific and try again.";
        return;
      }

      const { row, date } = matches[currentMatchIndex];
      selectedMatch = row;
      const now = new Date();
      const dateMidnight = new Date(date);
      dateMidnight.setHours(0, 0, 0, 0);
      const nowMidnight = new Date(now);
      nowMidnight.setHours(0, 0, 0, 0);
      const daysDiff = Math.floor((dateMidnight - nowMidnight) / (1000 * 60 * 60 * 24));

      let c_date = "";
      if (daysDiff === 0 || (daysDiff < 0 && now.toDateString() === date.toDateString())) {
        c_date = "Today";
      } else if (daysDiff === 1) {
        c_date = "Tomorrow";
      } else {
        c_date = `${Math.abs(daysDiff)} Days ${daysDiff < 0 ? "Ago" : "Away"}`;
      }

      const teamInputRaw = document.getElementById("teamSearch").value.trim();
      const timeFormatted = date.toLocaleString("en-US", {
        timeZone: "America/New_York",
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      });

      const timeString = `${c_date} @ ${timeFormatted} EST`;
      const matchedTeam = [row["Home Team"], row["Away Team"]].find(team =>
        team.toLowerCase().includes(teamInputRaw.toLowerCase())
      ) || teamInputRaw;

      container.innerHTML = `
        <div style="font-weight: bold; font-size: 20px; white-space: nowrap;">
          Results Found for '${teamInputRaw}': <span style="color: red;">${matches.length}</span>
        </div>
        <p style="margin-top:10px;">Did you mean:</p>
        <p style="text-align: center; margin: 5px 0 15px;">
          <strong style="font-size: 24px;">${matchedTeam}</strong>
        </p>
        <p>Sport: ${row["League (Group)"]}</p>
        <p>League: ${row["Sport Name"]}</p>
        <p>Next Event: ${row["Away Team"]} @ ${row["Home Team"]}</p>
        <p>When: ${c_date} @ ${timeFormatted} EST</p>
        <br />
        ${matches.length > 1 ? '<button onclick="nextOption()">Next Option</button>' : ''}
        <button onclick="useThisGame()">Use This Game</button>
      `;

      container.classList.remove("hidden");
    }

    function nextOption() {
      currentMatchIndex++;
      showGameOption();
    }

    // The rest of your existing code remains unchanged exactly as you provided, here it is fully:

    document.getElementById("accessCode").addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/\D/g, "");
      if (e.target.value.length > 10) {
        e.target.value = e.target.value.slice(0, 10);
      }
    });

    async function loadAllData() {
      try {
        const res = await fetch(BASE_URL + "?action=data");
        allData = await res.json();

        document.getElementById("loader").style.display = "none";
        document.getElementById("loadingMsg").style.display = "none";

        Array.from(document.querySelectorAll("#sports-screen > *")).forEach(el => {
          if (el.id !== "loader" && el.id !== "loadingMsg") {
            el.style.display = "";
          }
        });

        document.getElementById("loggedInInfo").classList.remove("hidden");
        document.getElementById("teamSearch").focus();
        document.getElementById("loginNotice").textContent = `Logged in as: ${capperName}`;

      } catch {
        alert("Failed to load sports data.");
      }
    }

    document.getElementById("teamSearch").addEventListener("keydown", e => {
      if (e.key === "Enter") searchGames();
    });
    document.getElementById("wagerType")?.addEventListener("keydown", e => {
      if (e.key === "Enter") submitWagerType();
    });
    document.getElementById("accessCode").addEventListener("keydown", e => {
      if (e.key === "Enter") validateAccess();
    });
    document.getElementById("unitDropdown").addEventListener("change", () => {
      submitUnitAmount();
    });

    function submitWagerType() {
      const wager = document.getElementById("wagerType").value.trim();
      const errorBox = document.getElementById("wagerError");

      const valid = /^[A-Za-z0-9 .]+$/.test(wager) && wager.length > 0;
      if (!valid) {
        errorBox.textContent = "The information entered does not conform to the standard or was left blank. Please check your entry, and try again.";
        return;
      }

      errorBox.textContent = "";

      document.getElementById("customInputSection").classList.add("hidden");
      document.getElementById("unitDropdownSection").classList.remove("hidden");

      buildUnitDropdown();

      document.getElementById("unitDropdownSection").classList.remove("hidden");
      document.getElementById("unitDropdown").focus();
    }

    function resetSearch() {
      // Clear global variables
      matches = [];
      currentMatchIndex = 0;
      selectedMatch = null;
      window.overrideTeamName = null;
      window.selectedHypeRow = null;
      window.selectedHypePostTitle = null;
      window.selectedHypeNote = null;
      window.latestNote = null;
      window.overrideTitle = null;
      window.currentWagerWithNum = null;
      parlayPicks = [];
      currentPickNumber = 1;
      pickType = "straight";

      // Clear inputs
      document.getElementById("teamSearch").value = "";
      const wagerDropdown = document.getElementById("wagerDropdown");
      if (wagerDropdown) wagerDropdown.selectedIndex = 0;

      const wagerTypeInput = document.getElementById("wagerType");
      if (wagerTypeInput) wagerTypeInput.value = "";

      const unitDropdown = document.getElementById("unitDropdown");
      if (unitDropdown) unitDropdown.selectedIndex = 0;

      document.getElementById("notesInput").value = "";

      // Clear error messages
      document.getElementById("searchError").textContent = "";
      const wagerError = document.getElementById("wagerError");
      if (wagerError) wagerError.textContent = "";
      const unitDropdownError = document.getElementById("unitDropdownError");
      if (unitDropdownError) unitDropdownError.textContent = "";
      const numInputError = document.getElementById("numInputError");
      if (numInputError) numInputError.textContent = "";

      // Hide all optional/secondary sections
      const toHide = [
        "gameSuggestion",
        "customInputSection",
        "unitDropdownSection",
        "notesChoiceSection",
        "notesInputSection",
        "confirmOutput",
        "submitNoteBtn",
        "hypePhraseStep"
      ];
      toHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      });

      // Clear hype phrase dropdowns and outputs
      const hypeASelect = document.getElementById("hypeASelect");
      if (hypeASelect) hypeASelect.selectedIndex = 0;
      const hypeBSelect = document.getElementById("hypeBSelect");
      if (hypeBSelect) {
        hypeBSelect.innerHTML = '<option value="">-- Select Energy of Hype Phrase --</option>';
        hypeBSelect.disabled = true;
      }
      const hypePhraseOutputs = document.getElementById("hypePhraseOutputs");
      if (hypePhraseOutputs) hypePhraseOutputs.innerHTML = "";

      // Clear confirm output and remove any appended toggle buttons or iframes
      const confirmOutput = document.getElementById("confirmOutput");
      if (confirmOutput) {
        confirmOutput.classList.add("hidden");
        confirmOutput.innerHTML = "";
      }
      const toggleBtn = document.getElementById("toggleImageBtn");
      if (toggleBtn) toggleBtn.remove();

      // Clear Post Title/Desc container
      const postContainer = document.getElementById("postTitleDescContainer");
      postContainer.innerHTML = "";

      // Show the main team search input section and label/buttons
      const inputLabel = document.getElementById("inputLabel");
      const teamSearch = document.getElementById("teamSearch");
      const searchBtn = document.getElementById("searchBtn");

      if (inputLabel) {
        inputLabel.classList.remove("hidden");
        inputLabel.style.display = "";
      }
      if (teamSearch) {
        teamSearch.classList.remove("hidden");
        teamSearch.style.display = "";
        teamSearch.focus();
      }
      if (searchBtn) {
        searchBtn.classList.remove("hidden");
        searchBtn.style.display = "";
      }

      // Hide the game suggestion container just in case
      const gameSuggestion = document.getElementById("gameSuggestion");
      if (gameSuggestion) gameSuggestion.classList.add("hidden");
    }

    function openImageGenerator() {
      const encodedText = encodeURIComponent(window._cleanedOutput || '');
      window.open(`${BASE_URL}?text=${encodedText}`, '_blank');
    }

    document.getElementById("yesNoteBtn").addEventListener("click", () => {
      document.getElementById("notesChoiceSection").classList.add("hidden");
      document.getElementById("notesInputSection").classList.remove("hidden");

      document.getElementById("notesHeaderRow").style.display = "flex";
      document.getElementById("submitNoteBtn").classList.remove("hidden");

      document.getElementById("notesInput").value = "";
      document.getElementById("charCount").textContent = "Remaining: 100";

      document.getElementById("notesInput").focus();
    });

    document.getElementById("noNoteBtn").addEventListener("click", () => {
      document.getElementById("notesChoiceSection").classList.add("hidden");
      // Show Hype Phrase step here instead of image creation
      showHypePhraseStep();
    });

    document.getElementById("submitNoteBtn").addEventListener("click", () => {
      const note = document.getElementById("notesInput").value.trim();
      document.getElementById("notesInputSection").classList.add("hidden");

      // Save latest note for hype step
      window.latestNote = note || "N/A";

      // Show Hype Phrase step instead of image creation
      showHypePhraseStep();
    });

    document.getElementById("notesInput").addEventListener("input", (e) => {
      const remaining = 100 - e.target.value.length;
      document.getElementById("charCount").textContent = `Remaining: ${remaining}`;
    });

    function showHypePhraseStep() {
      document.getElementById("notesChoiceSection").classList.add("hidden");
      document.getElementById("notesInputSection").classList.add("hidden");
      document.getElementById("hypePhraseStep").classList.remove("hidden");

      populateHypeACategories();
    }

    // Hype phrase dropdown population & event handlers
    function populateHypeACategories() {
      const selectA = document.getElementById("hypeASelect");
      selectA.innerHTML = '<option value="">-- Select Type of Hype Phrase --</option>';

      const categories = new Set();
      (allData.hypePhrases || []).forEach(row => {
        if (row.active_status === "active" && row.Type && !categories.has(row.Type)) {
          categories.add(row.Type);
        }
      });

      [...categories].sort().forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        selectA.appendChild(option);
      });

      const selectB = document.getElementById("hypeBSelect");
      selectB.innerHTML = '<option value="">-- Select Energy of Hype Phrase --</option>';
      selectB.disabled = true;

      document.getElementById("hypePhraseOutputs").innerHTML = "";
    }

    document.getElementById("hypeASelect").addEventListener("change", function () {
      const selectedType = this.value;
      const selectB = document.getElementById("hypeBSelect");
      selectB.innerHTML = '<option value="">-- Select Energy of Hype Phrase --</option>';

      if (!selectedType) {
        selectB.disabled = true;
        document.getElementById("hypePhraseOutputs").innerHTML = "";
        return;
      }

      const energies = new Set();
      (allData.hypePhrases || []).forEach(row => {
        if (row.active_status === "active" && row.Type === selectedType && row.Energy) {
          energies.add(row.Energy);
        }
      });

      [...energies].sort().forEach(energy => {
        const option = document.createElement("option");
        option.value = energy;
        option.textContent = energy;
        selectB.appendChild(option);
      });

      selectB.disabled = false;
      document.getElementById("hypePhraseOutputs").innerHTML = "";
    });

    // UPDATED hypeBSelect event to show ALL matches with hype phrases for each in random order:
    document.getElementById("hypeBSelect").addEventListener("change", function () {
      const selectedType = document.getElementById("hypeASelect").value;
      const selectedEnergy = this.value;
      const outputDiv = document.getElementById("hypePhraseOutputs");

      if (!selectedEnergy) {
        outputDiv.innerHTML = "";
        return;
      }

      // Filter hype phrases for selected Type and Energy
      const hypePhrases = (allData.hypePhrases || []).filter(row =>
        row.active_status === "active" &&
        row.Type === selectedType &&
        row.Energy === selectedEnergy
      );

      const unitVal = document.getElementById("unitDropdown")?.value || "[[UNIT]]";

      let html = "";

      // Shuffle matches so games appear in random order
      const shuffledMatches = matches.slice().sort(() => Math.random() - 0.5);

      // For each match found, display all hype phrases with that match's info
      shuffledMatches.forEach(match => {
        // Get game time for this match:
        const gameTime = match && match.row && match.row["Commence Time (UTC)"] ?
          new Date(match.row["Commence Time (UTC)"]).toLocaleString("en-US", {
            timeZone: "America/New_York",
            hour: "numeric",
            minute: "2-digit",
            hour12: true
          }) + " EST" : "N/A";

        // Get sport name for this match:
        const sportFromInput = match.row ? (match.row["Sport Name"] || "N/A") : "N/A";

        // Shuffle hype phrases for randomness
        const shuffledPhrases = hypePhrases.slice().sort(() => Math.random() - 0.5);

        shuffledPhrases.forEach(row => {
          const sport = row.Sport || "N/A";
          const phrase = row.Phrase || "";
          const promo = row.Promo || "";

          const postTitle = `${unitVal} UNIT(s) - ${phrase} - ${sportFromInput} - STARTS @ ${gameTime}`;
          const displaySport = (sport === "N/A" ? "Used for Any Sport" : sport);

          // Add data attributes for sport and commence time so click handler can use them:
          html += `
            <div class="hypeOutputBlock" tabindex="0" role="button" aria-pressed="false"
              style="border: 1px solid #2a9fd6; padding: 10px; margin-bottom: 10px; cursor: pointer; border-radius: 6px; font-size: 11px;"
              data-sport="${sportFromInput}"
              data-commencetime="${gameTime}"
              data-phrase="${phrase}"
              data-promo="${promo}"
            >
              <div><strong>Related Sport: </strong>${displaySport}</div>
              <div><strong>Post Title: </strong>${postTitle}</div>
              <div><strong>Post Desc: </strong><span>${promo}</span></div>
            </div>
          `;
        });
      });

      outputDiv.innerHTML = html;

      // Add click and keyboard handlers for all hype output blocks
      Array.from(outputDiv.querySelectorAll(".hypeOutputBlock")).forEach((block, i) => {
        block.onclick = () => {
          const sportFromInput = block.dataset.sport || "N/A";
          const gameTime = block.dataset.commencetime || "N/A";
          const phrase = block.dataset.phrase || "";
          const promo = block.dataset.promo || "";

          const unitVal = document.getElementById("unitDropdown")?.value || "[[UNIT]]";

          window.selectedHypePostTitle = `${unitVal} UNIT(s) - ${phrase} - ${sportFromInput} - STARTS @ ${gameTime}`;
          window.selectedHypeRow = { Promo: promo, Phrase: phrase, Sport: sportFromInput };
          window.selectedHypeNote = window.latestNote || "N/A";

          document.getElementById("hypePhraseStep").classList.add("hidden");

          generateFinalOutput(window.selectedHypeNote, window.selectedHypePostTitle);
        };
        block.onkeydown = (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            block.click();
          }
        };
      });
    });

    function generateFinalOutput(notes, newTitle) {
      notes = notes || "N/A";
      if (newTitle) window.overrideTitle = newTitle;

      let wagerRaw = "";
      const wagerInput = document.getElementById("wagerType");
      const wagerDropdown = document.getElementById("wagerDropdown");

      if (window.currentWagerWithNum) {
        wagerRaw = window.currentWagerWithNum;
      } else if (wagerInput) {
        wagerRaw = wagerInput.value.trim();
      } else if (wagerDropdown) {
        wagerRaw = wagerDropdown.value.trim();
      }
      const wager = wagerRaw.toUpperCase();

      const teamSearchEl = document.getElementById("teamSearch");
      const teamSearchInput = window.overrideTeamName || (teamSearchEl ? teamSearchEl.value.trim() : "");
      const dropdown = document.getElementById("unitDropdown");
      const unitInput = dropdown ? dropdown.value.trim() : "";
      const allInputsRaw = `${teamSearchInput} ${wagerRaw} ${unitInput}`;

      let matchedTeam = "";
      const teamSearchLower = teamSearchInput.toLowerCase();

      if (window.overrideTeamName) {
        matchedTeam = window.overrideTeamName;
      } else if (
        selectedMatch &&
        selectedMatch["Home Team"] !== "Unavailable" &&
        selectedMatch["Away Team"] !== "Unavailable"
      ) {
        const home = selectedMatch["Home Team"];
        const away = selectedMatch["Away Team"];
        matchedTeam = [home, away].find(team => team.toLowerCase().includes(teamSearchLower)) || teamSearchInput;
      } else {
        matchedTeam = teamSearchInput;
      }

      let formattedTime = "Unavailable";
      if (selectedMatch["Commence Time (UTC)"]) {
        const date = new Date(selectedMatch["Commence Time (UTC)"]);
        formattedTime = date.toLocaleString("en-US", {
          timeZone: "America/New_York",
          weekday: "short", month: "short", day: "numeric",
          hour: "numeric", minute: "2-digit", hour12: true
        }) + " ET";
      }

      const nowNY = new Date().toLocaleString("en-US", { timeZone: "America/New_York" });
      const nyDate = new Date(nowNY);
      const estString = `${nyDate.getFullYear()}-${String(nyDate.getMonth() + 1).padStart(2, '0')}-${String(nyDate.getDate()).padStart(2, '0')} ${String(nyDate.getHours()).padStart(2, '0')}:${String(nyDate.getMinutes()).padStart(2, '0')}:${String(nyDate.getSeconds()).padStart(2, '0')}`;

      const secondsSinceEpoch = Math.floor((new Date() - new Date("1981-07-25T12:00:00Z")) / 1000);
      const today = new Date();
      const mmddyy = `${today.getMonth() + 1}${today.getDate()}${today.getFullYear().toString().slice(2)}`;
      const pickId = `${secondsSinceEpoch}-${mmddyy}`;

      let pickDescValue = "Unavailable";

      if (document.getElementById("wagerDropdown") && !window.overrideTeamName) {
        const selectedWager = document.getElementById("wagerDropdown").value;
        const wagerRow = (allData.wagers || []).find(row =>
          row.wager_label_template === selectedWager
        );

        if (wagerRow && wagerRow.pick_desc_template) {
          pickDescValue = wagerRow.pick_desc_template;

          pickDescValue = pickDescValue.replace(/\[\[TEAM\]\]/g, matchedTeam);

          const numberMatch = selectedWager.match(/\d+(\.\d+)?/);
          if (numberMatch) {
            const numericValue = numberMatch[0];
            pickDescValue = pickDescValue
              .replace(/\[\[NUM\]\]/g, numericValue)
              .replace(/\[\[NUMBER\]\]/g, numericValue);
          }
        }
      }

      const output = [
        "═══════════════════════",
        "######## OFFICIAL PICK",
        "═══════════════════════",
        `Wager Type: STRAIGHT WAGER`,
        `Official Pick: ${matchedTeam}`,
        `Official Type: ${wager}`,
        `Official Wager: ${unitInput} Unit(s)`,
        `To Win: ${pickDescValue}`,
        "",
        "═══════════════════════",
        "######## GAME DETAILS",
        "═══════════════════════",
        `Sport: ${selectedMatch["League (Group)"].toUpperCase()}`,
        `League: ${selectedMatch["Sport Name"]}`,
        `Home Team: ${selectedMatch["Home Team"]}`,
        `Away Team: ${selectedMatch["Away Team"]}`,
        `Game Time: ${formattedTime}`,
        "",
        "═══════════════════════",
        "######## THANK YOU FOR TRUSTING OGCB",
        "═══════════════════════",
        "",
        `Title: ${window.overrideTitle || "[[TITLE]]"}`,
        `Pick ID: ${pickId}`,
        `Pick by: ${capperName}`,
        `Input Value: ${allInputsRaw}`,
        `Notes: ${notes}`,
        "",
        "═══════════════════════",
        "######## STRICT CONFIDENTIALITY NOTICE",
        "═══════════════════════",
        "All OG Capper Bets Content is PRIVATE. Leaking, Stealing or Sharing ANY Content is STRICTLY PROHIBITED.",
        "Violation = Termination. No Refund. No Appeal. Lifetime Ban.",
        "",
        `Created: ${estString}`
      ].join("\n");

      const box = document.getElementById("confirmOutput");
      box.classList.remove("hidden");
      box.innerHTML = "";

      const cleanedOutput = output.replace(/[\u2028\u2029]/g, '');
      window._cleanedOutput = cleanedOutput;

      const encodedOutput = encodeURIComponent(cleanedOutput);

      const existingFrame = document.getElementById("slipFrame");
      if (existingFrame) existingFrame.remove();

      const payload = {
        "FULL_TEAM_ENTERED": matchedTeam,
        "FULL_BET_TYPE": wager,
        "FULL_WAGER_OUTPUT": `${unitInput} Unit(s)`,
        "PICK_DESC": pickDescValue,
        "NOTES": notes,
        "FULL_LEAGUE_NAME": selectedMatch["Sport Name"],
        "FULL_SPORT_NAME": selectedMatch["League (Group)"],
        "HOME_TEAM_FULL_NAME": selectedMatch["Home Team"],
        "AWAY_TEAM_FULL_NAME": selectedMatch["Away Team"],
        "DATE and TIME OF GAME START": formattedTime,
        "TITLE": window.overrideTitle || "[[TITLE]]",
        "PICKID": pickId,
        "CAPPERS NAME": capperName,
        "USER_INPUT_VALUE": allInputsRaw,
        "24HR_LONG_DATE_SECONDS": estString
      };

      const encodedPayload = encodeURIComponent(JSON.stringify(payload));
      box.innerHTML = "";

      const createIframe = (slideNum, visible) => {
        const iframe = document.createElement("iframe");
        iframe.className = "slipFrame";
        iframe.dataset.slide = slideNum;
        iframe.style.display = visible ? "block" : "none";
        iframe.src = `${BASE_URL}?json=${encodedPayload}&slideNum=${slideNum}`;
        iframe.style.width = "100%";
        iframe.style.maxWidth = "400px";
        iframe.style.border = "none";
        iframe.style.height = "600px";
        iframe.style.zIndex = "1";
        return iframe;
      };

      // For parlay picks: use different slide docs
      if (pickType === "upTo5") {
        // Use slide 3 and 4 instead of 1 and 2
        const iframe1 = createIframe("3", true);
        const iframe2 = createIframe("4", false);

        box.appendChild(iframe1);
        box.appendChild(iframe2);
      } else if (pickType === "6to15") {
        // Use different Google Slides doc for 6-15 parlay (assuming handled in backend by slideNum param)
        // For demo: use slide 1 and 2 but backend should detect & use different doc if needed
        const iframe1 = createIframe("1", true);
        const iframe2 = createIframe("2", false);

        box.appendChild(iframe1);
        box.appendChild(iframe2);
      } else {
        // Straight pick default
        const iframe1 = createIframe("1", true);
        const iframe2 = createIframe("2", false);

        box.appendChild(iframe1);
        box.appendChild(iframe2);
      }

      // --- Add Post Title and Post Desc readonly textboxes here ---

      const postContainer = document.getElementById("postTitleDescContainer");
      postContainer.innerHTML = ""; // Clear old if any

      // Add label above Post Title input
      const postTitleLabel = document.createElement("div");
      postTitleLabel.textContent = "Tap to Copy - Paste in Patreon Post Title";
      postTitleLabel.className = "copyTextboxLabel";
      postContainer.appendChild(postTitleLabel);

      // Create Post Title textbox
      const postTitleInput = document.createElement("input");
      postTitleInput.type = "text";
      postTitleInput.readOnly = true;
      postTitleInput.className = "copyTextbox";
      postTitleInput.title = "Click to copy Post Title";
      postTitleInput.value = window.overrideTitle || "";
      postTitleInput.style.userSelect = "all";

      // Copy to clipboard on click
      postTitleInput.addEventListener("click", () => {
        navigator.clipboard.writeText(postTitleInput.value).then(() => {
          alert("Post Title copied to clipboard!");
        });
      });
      postContainer.appendChild(postTitleInput);

      // Add label above Post Desc input
      const postDescLabel = document.createElement("div");
      postDescLabel.textContent = "Tap to Copy - Paste in Patreon Post Description";
      postDescLabel.className = "copyTextboxLabel";
      postContainer.appendChild(postDescLabel);

      // Create Post Desc textbox (using span to preserve emojis)
      const postDescInput = document.createElement("input");
      postDescInput.type = "text";
      postDescInput.readOnly = true;
      postDescInput.className = "copyTextbox";
      postDescInput.title = "Click to copy Post Description";
      postDescInput.value = window.selectedHypeRow ? window.selectedHypeRow.Promo || "" : "";
      postDescInput.style.userSelect = "all";

      // Copy to clipboard on click
      postDescInput.addEventListener("click", () => {
        navigator.clipboard.writeText(postDescInput.value).then(() => {
          alert("Post Description copied to clipboard!");
        });
      });

      postContainer.appendChild(postDescInput);

      // --- End new additions ---

      const toggleBtn = document.createElement("button");
      toggleBtn.textContent = "Switch to Paid Image";
      toggleBtn.id = "toggleImageBtn";
      toggleBtn.style.marginTop = "10px";
      toggleBtn.style.width = "100%";
      toggleBtn.style.maxWidth = "400px";
      toggleBtn.style.boxSizing = "border-box";
      toggleBtn.style.padding = "12px";
      toggleBtn.style.fontSize = "16px";
      toggleBtn.style.backgroundColor = "#2a9fd6";
      toggleBtn.style.color = "white";
      toggleBtn.style.border = "none";
      toggleBtn.style.borderRadius = "6px";
      toggleBtn.style.cursor = "pointer";

      toggleBtn.onclick = () => {
        const frames = document.querySelectorAll(".slipFrame");
        frames.forEach(frame => {
          const isVisible = frame.style.display !== "none";
          frame.style.display = isVisible ? "none" : "block";
        });

        const showingSlide2 = box.querySelector('iframe[data-slide="2"], iframe[data-slide="4"]')?.style.display === "block";
        toggleBtn.textContent = showingSlide2 ? "Switch to Regular Image" : "Switch to Paid Image";
      };

      box.parentNode.insertBefore(toggleBtn, box);
      setTimeout(() => {
        box.style.overflow = "hidden";
        box.style.height = box.scrollHeight + "px";
      }, 0);
    }

    function buildWagerDropdown() {
      const wagerData = (allData.wagers || []).filter(row => row.active_status === 'active');
      const inputDiv = document.getElementById("customInputSection");

      inputDiv.innerHTML = `
        <label for="wagerDropdown" style="color:#666;font-size:14px;margin-bottom:5px;display:block;">
          Select Wager Type Below:
        </label>
        <select id="wagerDropdown"></select>
        <div class="error" id="wagerError"></div>
      `;

      const dropdown = document.getElementById("wagerDropdown");

      const defaultOpt = document.createElement("option");
      defaultOpt.textContent = "Select Item Below";
      defaultOpt.disabled = true;
      defaultOpt.selected = true;
      dropdown.appendChild(defaultOpt);

      const isOverride = !!window.overrideTeamName;

      let filteredWagerData = wagerData;

      if (!isOverride) {
        const detectedSport = selectedMatch?.["League (Group)"]?.trim() || "";
        filteredWagerData = wagerData.filter(row => {
          const rowSport = (row.Sport || "").trim();
          return !rowSport || rowSport.toLowerCase() === detectedSport.toLowerCase();
        });
      }

      filteredWagerData.forEach(row => {
        const opt = document.createElement("option");
        opt.textContent = row.wager_label_template;
        opt.value = row.wager_label_template;
        opt.dataset.requiresNumber = row.pick_desc_template.includes("[[NUM]]") ? "yes" : "no";
        dropdown.appendChild(opt);
      });

      const otherOpt = document.createElement("option");
      otherOpt.textContent = "Other (Manual Entry Override)";
      otherOpt.value = "__other";
      dropdown.appendChild(otherOpt);

      dropdown.addEventListener("change", () => {
        const selected = dropdown.value;
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        const requiresNumber = selectedOption.dataset.requiresNumber === "yes";

        if (selected === "__other") {
          inputDiv.innerHTML = `
            <label for="wagerType" style="color:#666;font-size:14px;margin-bottom:5px;display:block;">
              Enter Wager Type (e.g. 'ML' or 'F5')
            </label>
            <input type="text" id="wagerType" />
            <button id="submitWagerBtn">Submit</button>
            <div class="error" id="wagerError"></div>
          `;

          document.getElementById("submitWagerBtn").onclick = () => {
            submitWagerType();
          };

          document.getElementById("unitDropdownSection").classList.add("hidden");
        } else {
          if (requiresNumber && selected.includes("[[NUM]]")) {
            showNumInputScreen(selected);
          } else {
            document.getElementById("customInputSection").classList.add("hidden");
            buildUnitDropdown();
            document.getElementById("unitDropdownSection").classList.remove("hidden");
          }
        }
      });
    }

    function showNumInputScreen(wagerTemplate) {
      const inputDiv = document.getElementById("customInputSection");
      inputDiv.innerHTML = `
        <label for="numInput" style="color:#666;font-size:14px;margin-bottom:5px;display:block;" id="numInputLabel"></label>
        <input type="number" id="numInput" step="0.5" min="0.5" max="300" inputmode="decimal" pattern="^(0\\.5|[1-9][0-9]*([.]5)?)$" />
        <div class="error" id="numInputError"></div>
        <button id="numSubmitBtn">Submit</button>
      `;

      const label = document.getElementById("numInputLabel");
      label.textContent = `Enter the amount for [[NUM]] (${wagerTemplate})`;

      const numInput = document.getElementById("numInput");

      setTimeout(() => {
        numInput.focus();
      }, 100);

      numInput.addEventListener("input", () => {
        let val = numInput.value;
        const errorDiv = document.getElementById("numInputError");
        errorDiv.textContent = "";

        if (val === "") return;

        const num = parseFloat(val);
        if (isNaN(num) || num < 0.5 || num > 300 || (num * 2) % 1 !== 0) {
          errorDiv.textContent = "Please enter a positive number up to 300 in 0.5 increments (e.g. 0.5, 1, 1.5).";
        }
      });

      document.getElementById("numSubmitBtn").onclick = () => {
        const val = numInput.value.trim();
        const errorDiv = document.getElementById("numInputError");

        if (!val) {
          errorDiv.textContent = "Please enter a value.";
          numInput.focus();
          return;
        }
        const num = parseFloat(val);
        if (isNaN(num) || num < 0.5 || num > 300 || (num * 2) % 1 !== 0) {
          errorDiv.textContent = "Please enter a positive number up to 300 in 0.5 increments (e.g. 0.5, 1, 1.5).";
          numInput.focus();
          return;
        }

        window.currentWagerWithNum = wagerTemplate.replace(/\[\[NUM\]\]/g, val);

        errorDiv.textContent = "";
        document.getElementById("customInputSection").classList.add("hidden");
        buildUnitDropdown();
        document.getElementById("unitDropdownSection").classList.remove("hidden");
        document.getElementById("unitDropdown").focus();
      };
    }

    function buildUnitDropdown() {
      const unitData = allData.units || [];

      const dropdown = document.getElementById("unitDropdown");
      dropdown.innerHTML = "";

      const defaultOpt = document.createElement("option");
      defaultOpt.textContent = "Select Unit Amount...";
      defaultOpt.disabled = true;
      defaultOpt.selected = true;
      dropdown.appendChild(defaultOpt);

      unitData.forEach(row => {
        const opt = document.createElement("option");
        opt.textContent = row.display_unit;
        opt.value = row.display_unit;
        dropdown.appendChild(opt);
      });
    }

    document.getElementById("teamSearch").addEventListener("input", () => {
      document.getElementById("searchError").textContent = "";
    });

    // Load data after access validation and pick type selection
    async function startSportsScreen() {
      document.getElementById("loader").style.display = "block";
      document.getElementById("loadingMsg").style.display = "block";

      await loadAllData();

      document.getElementById("loader").style.display = "none";
      document.getElementById("loadingMsg").style.display = "none";
    }

    // Modified showSportsScreenInitial to call startSportsScreen
    // We now do that inside pick type button handlers:
    function showSportsScreenInitial() {
      const sportsScreen = document.getElementById("sports-screen");
      sportsScreen.classList.remove("hidden");

      document.getElementById("loggedInInfo").classList.remove("hidden");
      document.getElementById("loginNotice").textContent = `Logged in as: ${capperName}`;

      // Show main inputs: label, teamSearch, searchBtn
      document.getElementById("inputLabel").classList.remove("hidden");
      document.getElementById("inputLabel").style.display = "";
      document.getElementById("teamSearch").classList.remove("hidden");
      document.getElementById("teamSearch").style.display = "";
      document.getElementById("teamSearch").value = "";
      document.getElementById("teamSearch").focus();
      document.getElementById("searchBtn").classList.remove("hidden");
      document.getElementById("searchBtn").style.display = "";

      const optionalSections = [
        "gameSuggestion",
        "customInputSection",
        "unitDropdownSection",
        "notesChoiceSection",
        "notesInputSection",
        "confirmOutput",
        "submitNoteBtn",
        "hypePhraseStep"
      ];
      optionalSections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      });

      startSportsScreen();
    }

    // Hook submitUnitAmount to the unitDropdown change event for all flows
    document.getElementById("unitDropdown").addEventListener("change", () => {
      submitUnitAmount();
    });

  </script>
</body>
</html>
