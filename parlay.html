<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OG Capper Bets - Official Pick Image Creator v7.25</title>

  <link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Oswald', sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }

    input[type="number"],
    input[type="text"],
    select,
    textarea {
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      margin: 0 auto 12px;
      display: block;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      margin: 0 auto 12px;
      display: block;
      padding: 12px;
      font-size: 16px;
      background-color: #2a9fd6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #2179a5;
    }

    .hidden {
      display: none;
    }

    .error {
      color: red;
      font-size: 14px;
      margin-top: 10px;
    }

    #loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #2a9fd6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #confirmOutput {
      white-space: pre-wrap;
      font-family: monospace;
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      resize: none;
      overflow: hidden;
      min-height: 200px;
      height: auto;
    }

    #resetWrapper {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      height: 0;
    }

    #resetBtn {
      position: absolute;
      top: -35px;
      right: 0;
      font-size: 14px;
      padding: 4px 12px;
      background-color: #2a9fd6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      height: auto;
      width: auto;
      white-space: nowrap;
    }

    #copyBtn {
      margin-bottom: 10px;
    }

    #loginNotice {
      margin-bottom: 20px;
      font-weight: bold;
      color: gray;
      text-align: center;
    }

    #inputLabel {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    #gameSuggestion {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      background: #fff;
      margin-bottom: 20px;
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }

    #gameSuggestion p {
      margin: 6px 0;
    }

    #gameSuggestion strong {
      display: block;
      margin-bottom: 10px;
      font-size: 16px;
    }

    #gameTable,
    #sportDropdown {
      display: none;
    }

    #sports-screen {
      position: relative;
      overflow: hidden;
    }

    #imageLoader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #2a9fd6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    #imageLoaderText {
      font-size: 16px;
      font-weight: bold;
      color: #2a9fd6;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.2; }
    }

    .hypeOutputBlock {
      border: 1px solid #2a9fd6;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      border-radius: 6px;
      background-color: #eaf6ff;
      user-select: none;
    }
    .hypeOutputBlock:focus {
      outline: 2px solid #2179a5;
      outline-offset: 2px;
    }

    /* NEW styles for Post Title and Post Desc textboxes */
    .copyTextbox {
      font-family: 'Oswald', sans-serif !important;
      font-size: 11px !important;
      width: 100%;
      max-width: 400px;
      box-sizing: border-box;
      padding: 6px 10px;
      margin: 8px auto;
      border-radius: 6px;
      border: 1px solid #2a9fd6;
      background-color: #f0f8ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      user-select: all;
    }

    .copyTextbox:focus {
      outline: 2px solid #2179a5;
      outline-offset: 2px;
    }

    /* Titles above textboxes */
    .copyTextboxLabel {
      color: #666;
      font-size: 14px;
      margin: 12px 0 4px 0;
      font-weight: 600;
      font-family: 'Oswald', sans-serif;
      user-select: none;
    }

    /* New Pick Type Screen styles */
    #pickTypeScreen {
      margin-top: 20px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #pickTypeScreen button {
      height: 50px; /* 10-15px taller than normal 35-40px */
      font-size: 18px;
      font-weight: 600;
    }
  </style>
</head>
<body>

  <div class="container" id="access-screen">
    <div id="globalHeader" style="text-align: center; padding: 20px 0 10px;">
      <h3 style="margin: 0;">OG Capper Bets – Official Pick Image Creator v7.25</h3>
      <h5 style="margin: 0; color: red;">Official Use Only</h5>
    </div>

    <label style="color: #666; font-size: 14px; margin-bottom: 10px; display: block;">Enter Access Code</label>
    <input
      type="text"
      id="accessCode"
      placeholder="Enter Code Here"
      pattern="[0-9]*"
      inputmode="numeric"
      maxlength="10"
      style="width: 100%; max-width: 400px; box-sizing: border-box; display: block; margin: 0 auto 12px; padding: 12px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc;"
    />
    <button id="accessBtn" onclick="validateAccess()">Submit</button>
    <div class="error" id="error"></div>
  </div>

  <!-- New Pick Type Screen, hidden initially -->
  <div class="container hidden" id="pickTypeScreen">
    <button id="btnStraightPick" type="button">Straight Pick</button>
    <button id="btnUpTo5Parlay" type="button">Up to 5 Parlay Picks</button>
    <button id="btn6to15Parlay" type="button">6 to 15 Parlay Picks</button>
  </div>

  <div class="container hidden" id="sports-screen">
    <div id="loader"></div>
    <div id="loadingMsg" style="text-align:center; font-weight:bold;">Loading Games...</div>

    <div id="loggedInInfo" class="hidden">
      <div id="globalHeader" style="text-align: center; padding: 20px 0 10px;">
        <h3 style="margin: 0;">OG Capper Bets – Official Pick Image Creator v7.25</h3>
        <h5 style="margin: 0; color: red;">Official Use Only</h5>
        <h5 id="loginNotice"></h5>
      </div>

      <div id="resetWrapper">
        <button id="resetBtn" onclick="resetSearch()">Reset</button>
      </div>

      <div id="postTitleDescContainer" style="margin-top: 10px; max-width: 400px;">
        <!-- Dynamic post title and desc inputs inserted here -->
      </div>

      <div id="gameSuggestion" class="hidden"></div>
    </div>

    <div id="inputLabel">Enter Team Name: (e.g. 'Chicago Cubs' or 'Cubs')</div>
    <input type="text" id="teamSearch" placeholder="Must be at least 3 Characters" />
    <button id="searchBtn" onclick="searchGames()">Submit</button>
    <div class="error" id="searchError"></div>

    <div id="customInputSection" class="hidden"></div>

    <div id="unitDropdownSection" class="hidden">
      <label for="unitDropdown" style="color:#666;font-size:14px;margin-bottom:5px;display:block;">
        Select Unit(s):
      </label>
      <select id="unitDropdown"></select>
      <div class="error" id="unitDropdownError"></div>
    </div>

    <div id="notesChoiceSection" class="hidden">
      <label style="color: #666; font-size: 14px; margin-bottom: 10px; display: block;">
        Do You Want to Include any Comments/Notes?
      </label>
      <button id="yesNoteBtn">Yes, Enter Comment/Note</button>
      <button id="noNoteBtn">No, Proceed to Next Step</button>
    </div>

    <div id="notesInputSection" class="hidden" style="margin-top: 20px;">
      <div id="notesHeaderRow" style="display: none; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <label for="notesInput" style="color: #666; font-size: 14px;">
          Enter Your Comment/Note Below:
        </label>
        <div id="charCount" style="color: #666; font-size: 14px;">
          Remaining: 100
        </div>
      </div>

      <textarea
        id="notesInput"
        rows="2"
        maxlength="100"
        placeholder="Enter Comment/Note Here"
        style="font-family: 'Oswald', Arial, sans-serif; font-size: 14px; width: 100%; box-sizing: border-box;"
      ></textarea>

      <button id="submitNoteBtn" class="hidden">Submit</button>
    </div>

    <div id="hypePhraseStep" class="hidden" style="margin-top: 20px;">
      <label for="hypeASelect" style="color:#666; font-size:14px; margin-bottom:5px; display:block;">
        Select Type of Hype Phrase:
      </label>
      <select id="hypeASelect"></select>

      <label for="hypeBSelect" style="color:#666; font-size:14px; margin-bottom:5px; display:block; margin-top: 15px;">
        Select Energy of Hype Phrase:
      </label>
      <select id="hypeBSelect" disabled></select>

      <div id="hypePhraseOutputs" style="margin-top: 15px;"></div>
    </div>

    <pre id="confirmOutput" class="hidden"></pre>
  </div>

  <script>
    const BASE_URL = "https://script.google.com/macros/s/AKfycbzbNo6fcQsDvPSlsaC9y1U3NsO214vuS-7a6EwhtFXi-sH3fHQaJawg6LDehcf4TCepkA/exec";
    let capperInfo = [], allData = {}, currentMatchIndex = 0, matches = [], selectedMatch = null, capperName = "";

    // Parlay pick management variables
    let pickType = "straight"; // "straight", "upTo5", or "6to15"
    let parlayPicks = [];
    let currentPickNumber = 1;

    window.onload = async () => {
      try {
        const res = await fetch(BASE_URL + "?action=capperOnly");
        const result = await res.json();
        capperInfo = result.capperInfo;

        document.getElementById("accessCode").disabled = false;
        document.getElementById("accessBtn").disabled = false;
        document.getElementById("accessCode").focus();
      } catch {
        document.getElementById("error").textContent = "Failed to load access codes.";
      }
    };

    // Validate access code, then show pick type screen
    function validateAccess() {
      const code = document.getElementById("accessCode").value.trim();
      const match = capperInfo.find(row => row["Access Code"] == code);
      if (code.length < 4 || code.length > 10 || !match) {
        document.getElementById("error").textContent = "Access Code Invalid. Please Enter a Valid Access Code.";
        return;
      }

      capperName = match["Display Name"];
      document.getElementById("access-screen").classList.add("hidden");

      // Show pick type screen
      document.getElementById("pickTypeScreen").classList.remove("hidden");

      // Reset variables
      parlayPicks = [];
      currentPickNumber = 1;
      pickType = "straight";
    }

    // Access code input cleanup
    document.getElementById("accessCode").addEventListener("input", (e) => {
      e.target.value = e.target.value.replace(/\D/g, "");
      if (e.target.value.length > 10) {
        e.target.value = e.target.value.slice(0, 10);
      }
    });

    // Pick Type Buttons handlers
    document.getElementById("btnStraightPick").addEventListener("click", () => {
      pickType = "straight";
      document.getElementById("pickTypeScreen").classList.add("hidden");
      showSportsScreenInitial();
    });

    document.getElementById("btnUpTo5Parlay").addEventListener("click", () => {
      pickType = "upTo5";
      parlayPicks = [];
      currentPickNumber = 1;
      document.getElementById("pickTypeScreen").classList.add("hidden");
      showSportsScreenInitial();
    });

    document.getElementById("btn6to15Parlay").addEventListener("click", () => {
      pickType = "6to15";
      parlayPicks = [];
      currentPickNumber = 1;
      document.getElementById("pickTypeScreen").classList.add("hidden");
      showSportsScreenInitial();
    });

    // Show Sports Screen initial UI and load data
    async function showSportsScreenInitial() {
      document.getElementById("sports-screen").classList.remove("hidden");

      document.getElementById("loggedInInfo").classList.remove("hidden");
      document.getElementById("loginNotice").textContent = `Logged in as: ${capperName}`;

      document.getElementById("inputLabel").classList.remove("hidden");
      document.getElementById("inputLabel").style.display = "";
      document.getElementById("teamSearch").classList.remove("hidden");
      document.getElementById("teamSearch").style.display = "";
      document.getElementById("teamSearch").value = "";
      document.getElementById("teamSearch").focus();
      document.getElementById("searchBtn").classList.remove("hidden");
      document.getElementById("searchBtn").style.display = "";

      const optionalSections = [
        "gameSuggestion",
        "customInputSection",
        "unitDropdownSection",
        "notesChoiceSection",
        "notesInputSection",
        "confirmOutput",
        "submitNoteBtn",
        "hypePhraseStep"
      ];
      optionalSections.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      });

      // Load all data once
      await loadAllData();
    }

    async function loadAllData() {
      try {
        const res = await fetch(BASE_URL + "?action=data");
        allData = await res.json();

        document.getElementById("loader").style.display = "none";
        document.getElementById("loadingMsg").style.display = "none";

        Array.from(document.querySelectorAll("#sports-screen > *")).forEach(el => {
          if (el.id !== "loader" && el.id !== "loadingMsg") {
            el.style.display = "";
          }
        });

        document.getElementById("loggedInInfo").classList.remove("hidden");
        document.getElementById("teamSearch").focus();
        document.getElementById("loginNotice").textContent = `Logged in as: ${capperName}`;

      } catch {
        alert("Failed to load sports data.");
      }
    }

    document.getElementById("teamSearch").addEventListener("keydown", e => {
      if (e.key === "Enter") searchGames();
    });
    document.getElementById("wagerType")?.addEventListener("keydown", e => {
      if (e.key === "Enter") submitWagerType();
    });
    document.getElementById("accessCode").addEventListener("keydown", e => {
      if (e.key === "Enter") validateAccess();
    });
    document.getElementById("unitDropdown").addEventListener("change", () => {
      submitUnitAmount();
    });

    // GAME SEARCH & SELECTION
    function searchGames() {
      const input = document.getElementById("teamSearch").value.trim().toLowerCase();
      const rows = allData.gameCache || [];
      const resultSet = [];

      for (let row of rows) {
        const home = (row["Home Team"] || "").toLowerCase();
        const away = (row["Away Team"] || "").toLowerCase();
        const date = new Date(row["Commence Time (UTC)"]);

        if (input === home || input === away ||
          home.split(" ").includes(input) || away.split(" ").includes(input) ||
          (input.length >= 3 && (home.includes(input) || away.includes(input)))) {
          resultSet.push({ row, date });
        }
      }

      matches = resultSet.sort((a, b) => a.date - b.date);
      currentMatchIndex = 0;

      if (matches.length > 0) {
        const input = document.getElementById("teamSearch");
        const label = document.getElementById("inputLabel");
        const button = document.getElementById("searchBtn");

        input.classList.add("hidden");
        label.classList.add("hidden");
        button.classList.add("hidden");

        input.style.display = "none";
        label.style.display = "none";
        button.style.display = "none";
      }

      showGameOption();
    }

    function showGameOption() {
      const container = document.getElementById("gameSuggestion");
      const searchError = document.getElementById("searchError");

      container.classList.add("hidden");
      searchError.textContent = "";

      if (matches.length === 0) {
        const teamInputRaw = document.getElementById("teamSearch").value.trim();

        searchError.innerHTML = `
          <div style="color: red; font-weight: bold;">
            No matching games found for '${teamInputRaw}'.
            <br>
            Please be more specific and try again.
          </div>

          <h3 style="margin-top: 10px; color: black;">Manual Override Option:</h3>
          <p style="color: black;">
            If you have tried being more specific and checked for spelling errors and are still receiving 0 results,
            you can manually override the lookup function and use your input value of <strong>'${teamInputRaw}'</strong> instead.
            <br><br>
            Please double check the spelling and use the complete name before Overriding.
          </p>
          <h3 style="color: black;">Your Input Value: '${teamInputRaw}'</h3>
          <button id="overrideBtn" style="margin-top: 10px; padding: 10px; background-color: #d9534f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
            Override – Use Value Above
          </button>
        `;

        document.getElementById("overrideBtn").onclick = function () {
          const overrideValue = teamInputRaw;
          window.overrideTeamName = overrideValue;
          selectedMatch = {
            "League (Group)": "Unavailable",
            "Sport Name": "Unavailable",
            "Home Team": "Unavailable",
            "Away Team": "Unavailable",
            "Commence Time (UTC)": null
          };

          const input = document.getElementById("teamSearch");
          const label = document.getElementById("inputLabel");
          const button = document.getElementById("searchBtn");

          input.classList.add("hidden");
          label.classList.add("hidden");
          button.classList.add("hidden");

          input.style.display = "none";
          label.style.display = "none";
          button.style.display = "none";

          document.getElementById("searchError").innerHTML = "";
          document.getElementById("gameSuggestion").classList.add("hidden");

          document.getElementById("customInputSection").classList.remove("hidden");
          buildWagerDropdown();
        };

        return;
      }

      if (currentMatchIndex >= matches.length) {
        searchError.textContent = "No more matches. Please be more specific and try again.";
        return;
      }

      const { row, date } = matches[currentMatchIndex];
      selectedMatch = row;
      const now = new Date();
      const dateMidnight = new Date(date);
      dateMidnight.setHours(0, 0, 0, 0);
      const nowMidnight = new Date(now);
      nowMidnight.setHours(0, 0, 0, 0);
      const daysDiff = Math.floor((dateMidnight - nowMidnight) / (1000 * 60 * 60 * 24));

      let c_date = "";
      if (daysDiff === 0 || (daysDiff < 0 && now.toDateString() === date.toDateString())) {
        c_date = "Today";
      } else if (daysDiff === 1) {
        c_date = "Tomorrow";
      } else {
        c_date = `${Math.abs(daysDiff)} Days ${daysDiff < 0 ? "Ago" : "Away"}`;
      }

      const teamInputRaw = document.getElementById("teamSearch").value.trim();
      const timeFormatted = date.toLocaleString("en-US", {
        timeZone: "America/New_York",
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      });

      const matchedTeam = [row["Home Team"], row["Away Team"]].find(team =>
        team.toLowerCase().includes(teamInputRaw.toLowerCase())
      ) || teamInputRaw;

      container.innerHTML = `
        <div style="font-weight: bold; font-size: 20px; white-space: nowrap;">
          Results Found for '${teamInputRaw}': <span style="color: red;">${matches.length}</span>
        </div>
        <p style="margin-top:10px;">Did you mean:</p>
        <p style="text-align: center; margin: 5px 0 15px;">
          <strong style="font-size: 24px;">${matchedTeam}</strong>
        </p>
        <p>Sport: ${row["League (Group)"]}</p>
        <p>League: ${row["Sport Name"]}</p>
        <p>Next Event: ${row["Away Team"]} @ ${row["Home Team"]}</p>
        <p>When: ${c_date} @ ${timeFormatted} EST</p>
        <br />
        ${matches.length > 1 ? '<button onclick="nextOption()">Next Option</button>' : ''}
        <button onclick="useThisGame()">Use This Game</button>
      `;

      container.classList.remove("hidden");
    }

    function nextOption() {
      currentMatchIndex++;
      showGameOption();
    }

    // Modified useThisGame to handle parlay flow
    function useThisGame() {
      document.getElementById("gameSuggestion").classList.add("hidden");

      document.getElementById("inputLabel").classList.add("hidden");
      document.getElementById("teamSearch").classList.add("hidden");
      document.getElementById("searchBtn").classList.add("hidden");

      document.getElementById("customInputSection").classList.remove("hidden");
      buildWagerDropdown();
    }

    // Override buildWagerDropdown to add parlay handling
    function buildWagerDropdown() {
      const wagerData = (allData.wagers || []).filter(row => row.active_status === 'active');
      const inputDiv = document.getElementById("customInputSection");

      inputDiv.innerHTML = `
        <label for="wagerDropdown" style="color:#666;font-size:14px;margin-bottom:5px;display:block;">
          Select Wager Type Below:
        </label>
        <select id="wagerDropdown"></select>
        <div class="error" id="wagerError"></div>
      `;

      const dropdown = document.getElementById("wagerDropdown");

      const defaultOpt = document.createElement("option");
      defaultOpt.textContent = "Select Item Below";
      defaultOpt.disabled = true;
      defaultOpt.selected = true;
      dropdown.appendChild(defaultOpt);

      const isOverride = !!window.overrideTeamName;

      let filteredWagerData = wagerData;

      if (!isOverride) {
        const detectedSport = selectedMatch?.["League (Group)"]?.trim() || "";
        filteredWagerData = wagerData.filter(row => {
          const rowSport = (row.Sport || "").trim();
          return !rowSport || rowSport.toLowerCase() === detectedSport.toLowerCase();
        });
      }

      filteredWagerData.forEach(row => {
        const opt = document.createElement("option");
        opt.textContent = row.wager_label_template;
        opt.value = row.wager_label_template;
        opt.dataset.requiresNumber = row.pick_desc_template.includes("[[NUM]]") ? "yes" : "no";
        dropdown.appendChild(opt);
      });

      const otherOpt = document.createElement("option");
      otherOpt.textContent = "Other (Manual Entry Override)";
      otherOpt.value = "__other";
      dropdown.appendChild(otherOpt);

      dropdown.addEventListener("change", () => {
        const selected = dropdown.value;
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        const requiresNumber = selectedOption.dataset.requiresNumber === "yes";

        if (selected === "__other") {
          inputDiv.innerHTML = `
            <label for="wagerType" style="color:#666;font-size:14px;margin-bottom:5px;display:block;">
              Enter Wager Type (e.g. 'ML' or 'F5')
            </label>
            <input type="text" id="wagerType" />
            <button id="submitWagerBtn">Submit</button>
            <div class="error" id="wagerError"></div>
          `;

          document.getElementById("submitWagerBtn").onclick = () => {
            submitWagerType();
          };

          document.getElementById("unitDropdownSection").classList.add("hidden");
        } else {
          if (requiresNumber && selected.includes("[[NUM]]")) {
            showNumInputScreen(selected);
          } else {
            document.getElementById("customInputSection").classList.add("hidden");
            buildUnitDropdown();
            document.getElementById("unitDropdownSection").classList.remove("hidden");
          }
        }
      });
    }

    // Show number input screen for wagers requiring [[NUM]]
    function showNumInputScreen(wagerTemplate) {
      const inputDiv = document.getElementById("customInputSection");
      inputDiv.innerHTML = `
        <label for="numInput" style="color:#666;font-size:14px;margin-bottom:5px;display:block;" id="numInputLabel"></label>
        <input type="number" id="numInput" step="0.5" min="0.5" max="300" inputmode="decimal" pattern="^(0\\.5|[1-9][0-9]*([.]5)?)$" />
        <div class="error" id="numInputError"></div>
        <button id="numSubmitBtn">Submit</button>
      `;

      const label = document.getElementById("numInputLabel");
      label.textContent = `Enter the amount for [[NUM]] (${wagerTemplate})`;

      const numInput = document.getElementById("numInput");

      setTimeout(() => {
        numInput.focus();
      }, 100);

      numInput.addEventListener("input", () => {
        let val = numInput.value;
        const errorDiv = document.getElementById("numInputError");
        errorDiv.textContent = "";

        if (val === "") return;

        const num = parseFloat(val);
        if (isNaN(num) || num < 0.5 || num > 300 || (num * 2) % 1 !== 0) {
          errorDiv.textContent = "Please enter a positive number up to 300 in 0.5 increments (e.g. 0.5, 1, 1.5).";
        }
      });

      document.getElementById("numSubmitBtn").onclick = () => {
        const val = numInput.value.trim();
        const errorDiv = document.getElementById("numInputError");

        if (!val) {
          errorDiv.textContent = "Please enter a value.";
          numInput.focus();
          return;
        }
        const num = parseFloat(val);
        if (isNaN(num) || num < 0.5 || num > 300 || (num * 2) % 1 !== 0) {
          errorDiv.textContent = "Please enter a positive number up to 300 in 0.5 increments (e.g. 0.5, 1, 1.5).";
          numInput.focus();
          return;
        }

        window.currentWagerWithNum = wagerTemplate.replace(/\[\[NUM\]\]/g, val);

        errorDiv.textContent = "";
        document.getElementById("customInputSection").classList.add("hidden");
        buildUnitDropdown();
        document.getElementById("unitDropdownSection").classList.remove("hidden");
        document.getElementById("unitDropdown").focus();
      };
    }

    // Build units dropdown
    function buildUnitDropdown() {
      const unitData = allData.units || [];

      const dropdown = document.getElementById("unitDropdown");
      dropdown.innerHTML = "";

      const defaultOpt = document.createElement("option");
      defaultOpt.textContent = "Select Unit Amount...";
      defaultOpt.disabled = true;
      defaultOpt.selected = true;
      dropdown.appendChild(defaultOpt);

      unitData.forEach(row => {
        const opt = document.createElement("option");
        opt.textContent = row.display_unit;
        opt.value = row.display_unit;
        dropdown.appendChild(opt);
      });
    }

    // Submit unit amount with parlay pick logic
    function submitUnitAmount() {
      const dropdown = document.getElementById("unitDropdown");
      const input = dropdown ? dropdown.value : "";
      const errorDiv = document.getElementById("unitDropdownError");

      if (!input || input === "Select Unit(s)" || input === "") {
        errorDiv.textContent = "Please select a valid unit amount.";
        return;
      }

      errorDiv.textContent = "";

      if (pickType === "straight") {
        // Normal flow: hide unitDropdown and show notesChoiceSection
        document.getElementById("unitDropdownSection").classList.add("hidden");
        document.getElementById("notesChoiceSection").classList.remove("hidden");
      } else {
        // Parlay pick flow
        // Collect current pick data and store in parlayPicks array with pick number

        // Compose current pick data snapshot:
        const teamSearchEl = document.getElementById("teamSearch");
        const teamName = window.overrideTeamName || (teamSearchEl ? teamSearchEl.value.trim() : "");
        const wagerInput = document.getElementById("wagerType");
        const wagerDropdown = document.getElementById("wagerDropdown");
        let wagerRaw = "";

        if (window.currentWagerWithNum) {
          wagerRaw = window.currentWagerWithNum;
        } else if (wagerInput && wagerInput.value.trim()) {
          wagerRaw = wagerInput.value.trim();
        } else if (wagerDropdown && wagerDropdown.value.trim()) {
          wagerRaw = wagerDropdown.value.trim();
        }

        const unitVal = input;

        // Clone selectedMatch so changes later won't affect saved picks
        const matchCopy = JSON.parse(JSON.stringify(selectedMatch || {}));

        // Store pick data as object with pick number suffix
        const pickData = {
          pickNumber: currentPickNumber,
          teamName: teamName,
          wagerRaw: wagerRaw,
          unitVal: unitVal,
          match: matchCopy
        };

        parlayPicks.push(pickData);

        // Reset currentWagerWithNum to null for next pick
        window.currentWagerWithNum = null;

        // Hide unitDropdownSection to prevent duplicate pick submits
        document.getElementById("unitDropdownSection").classList.add("hidden");

        if (pickType === "upTo5") {
          if (currentPickNumber < 5) {
            // Show button to add another parlay pick
            showAddAnotherPickOption(true);
          } else {
            // Max picks reached, proceed to notesChoiceSection
            showAddAnotherPickOption(false);
          }
        } else if (pickType === "6to15") {
          if (currentPickNumber < 6) {
            // Must force add more picks until 6 reached: only show Add Another Pick, hide submit button
            showAddAnotherPickOption(true, true);
          } else if (currentPickNumber < 15) {
            // Show both buttons: Add Another Pick and Submit Picks
            showAddAnotherPickOption(true);
          } else {
            // Max picks reached 15, only submit
            showAddAnotherPickOption(false);
          }
        }

        // Disable teamSearch and wager inputs so user cannot change them mid-parlay pick session
        disableTeamAndWagerInputs(true);
      }

      function showAddAnotherPickOption(showAddButton, forceAddOnly = false) {
        // Hide all sections except customInputSection for buttons
        document.getElementById("customInputSection").classList.add("hidden");
        document.getElementById("notesChoiceSection").classList.add("hidden");
        document.getElementById("notesInputSection").classList.add("hidden");
        document.getElementById("confirmOutput").classList.add("hidden");
        document.getElementById("hypePhraseStep").classList.add("hidden");

        // Create container below unitDropdownSection for buttons
        let container = document.getElementById("parlayPickButtonsContainer");
        if (!container) {
          container = document.createElement("div");
          container.id = "parlayPickButtonsContainer";
          container.style.maxWidth = "400px";
          container.style.margin = "10px auto 20px auto";
          container.style.display = "flex";
          container.style.justifyContent = "space-between";
          container.style.gap = "10px";
          document.getElementById("unitDropdownSection").parentNode.insertBefore(container, document.getElementById("unitDropdownSection").nextSibling);
        }

        container.innerHTML = "";

        if (showAddButton) {
          const addBtn = document.createElement("button");
          addBtn.textContent = `Add Another Parlay Pick (Pick ${currentPickNumber + 1})`;
          addBtn.style.flex = "1";
          addBtn.onclick = () => {
            container.innerHTML = "";
            currentPickNumber++;
            resetForNextPick();
          };
          container.appendChild(addBtn);
        }

        if (!forceAddOnly) {
          const submitBtn = document.createElement("button");
          submitBtn.textContent = "Submit All Picks";
          submitBtn.style.flex = "1";
          submitBtn.onclick = () => {
            container.innerHTML = "";
            finalizeParlayPicks();
          };
          container.appendChild(submitBtn);
        }
      }

      // Reset inputs for next parlay pick
      function resetForNextPick() {
        // Reset UI for teamSearch + wager inputs
        document.getElementById("inputLabel").classList.remove("hidden");
        document.getElementById("inputLabel").style.display = "";
        document.getElementById("teamSearch").classList.remove("hidden");
        document.getElementById("teamSearch").style.display = "";
        document.getElementById("teamSearch").value = "";
        document.getElementById("teamSearch").focus();

        // Reset wager section
        document.getElementById("customInputSection").classList.remove("hidden");
        document.getElementById("customInputSection").innerHTML = "";
        buildWagerDropdown();

        // Show search button
        document.getElementById("searchBtn").classList.remove("hidden");
        document.getElementById("searchBtn").style.display = "";

        // Reset overrideTeamName and selectedMatch to null for fresh pick
        window.overrideTeamName = null;
        selectedMatch = null;
        matches = [];
        currentMatchIndex = 0;

        // Reset other inputs and errors
        document.getElementById("unitDropdownSection").classList.add("hidden");
        document.getElementById("unitDropdown").innerHTML = "";
        document.getElementById("unitDropdownError").textContent = "";
        document.getElementById("searchError").textContent = "";

        // Enable inputs for teamSearch and wager
        disableTeamAndWagerInputs(false);
      }

      // Disable or enable teamSearch and wager inputs to avoid mid-parlay changes
      function disableTeamAndWagerInputs(disable) {
        document.getElementById("teamSearch").disabled = disable;
        const wagerDropdown = document.getElementById("wagerDropdown");
        if (wagerDropdown) wagerDropdown.disabled = disable;
        const wagerType = document.getElementById("wagerType");
        if (wagerType) wagerType.disabled = disable;
        document.getElementById("searchBtn").disabled = disable;
      }

      // Called when submitting all picks in parlay
      function finalizeParlayPicks() {
        // Hide any parlay buttons container if present
        const container = document.getElementById("parlayPickButtonsContainer");
        if (container) container.innerHTML = "";

        // Proceed to notes section before final output
        document.getElementById("notesChoiceSection").classList.remove("hidden");

        // Disable team and wager inputs now
        disableTeamAndWagerInputs(true);
      }
    }

    // Reset search: clear everything and go back to pick type screen
    function resetSearch() {
      // Clear global variables
      matches = [];
      currentMatchIndex = 0;
      selectedMatch = null;
      window.overrideTeamName = null;
      window.selectedHypeRow = null;
      window.selectedHypePostTitle = null;
      window.selectedHypeNote = null;
      window.latestNote = null;
      window.overrideTitle = null;
      window.currentWagerWithNum = null;
      parlayPicks = [];
      currentPickNumber = 1;
      pickType = "straight";

      // Clear inputs
      document.getElementById("teamSearch").value = "";
      const wagerDropdown = document.getElementById("wagerDropdown");
      if (wagerDropdown) wagerDropdown.selectedIndex = 0;

      const wagerTypeInput = document.getElementById("wagerType");
      if (wagerTypeInput) wagerTypeInput.value = "";

      const unitDropdown = document.getElementById("unitDropdown");
      if (unitDropdown) unitDropdown.selectedIndex = 0;

      document.getElementById("notesInput").value = "";

      // Clear error messages
      document.getElementById("searchError").textContent = "";
      const wagerError = document.getElementById("wagerError");
      if (wagerError) wagerError.textContent = "";
      const unitDropdownError = document.getElementById("unitDropdownError");
      if (unitDropdownError) unitDropdownError.textContent = "";
      const numInputError = document.getElementById("numInputError");
      if (numInputError) numInputError.textContent = "";

      // Hide all optional/secondary sections
      const toHide = [
        "gameSuggestion",
        "customInputSection",
        "unitDropdownSection",
        "notesChoiceSection",
        "notesInputSection",
        "confirmOutput",
        "submitNoteBtn",
        "hypePhraseStep",
        "pickTypeScreen"
      ];
      toHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      });

      // Clear hype phrase dropdowns and outputs
      const hypeASelect = document.getElementById("hypeASelect");
      if (hypeASelect) hypeASelect.selectedIndex = 0;
      const hypeBSelect = document.getElementById("hypeBSelect");
      if (hypeBSelect) {
        hypeBSelect.innerHTML = '<option value="">-- Select Energy of Hype Phrase --</option>';
        hypeBSelect.disabled = true;
      }
      const hypePhraseOutputs = document.getElementById("hypePhraseOutputs");
      if (hypePhraseOutputs) hypePhraseOutputs.innerHTML = "";

      // Clear confirm output and remove any appended toggle buttons or iframes
      const confirmOutput = document.getElementById("confirmOutput");
      if (confirmOutput) {
        confirmOutput.classList.add("hidden");
        confirmOutput.innerHTML = "";
      }
      const toggleBtn = document.getElementById("toggleImageBtn");
      if (toggleBtn) toggleBtn.remove();

      // Clear Post Title/Desc container
      const postContainer = document.getElementById("postTitleDescContainer");
      postContainer.innerHTML = "";

      // Show pick type screen again
      document.getElementById("pickTypeScreen").classList.remove("hidden");

      // Show the main team search input section and label/buttons hidden
      const inputLabel = document.getElementById("inputLabel");
      const teamSearch = document.getElementById("teamSearch");
      const searchBtn = document.getElementById("searchBtn");

      if (inputLabel) {
        inputLabel.classList.add("hidden");
        inputLabel.style.display = "none";
      }
      if (teamSearch) {
        teamSearch.classList.add("hidden");
        teamSearch.style.display = "none";
      }
      if (searchBtn) {
        searchBtn.classList.add("hidden");
        searchBtn.style.display = "none";
      }

      // Hide the game suggestion container just in case
      const gameSuggestion = document.getElementById("gameSuggestion");
      if (gameSuggestion) gameSuggestion.classList.add("hidden");
    }

    // NOTES / HYPE PHRASE / FINAL OUTPUT FLOW UNCHANGED

    document.getElementById("yesNoteBtn").addEventListener("click", () => {
      document.getElementById("notesChoiceSection").classList.add("hidden");
      document.getElementById("notesInputSection").classList.remove("hidden");

      document.getElementById("notesHeaderRow").style.display = "flex";
      document.getElementById("submitNoteBtn").classList.remove("hidden");

      document.getElementById("notesInput").value = "";
      document.getElementById("charCount").textContent = "Remaining: 100";

      document.getElementById("notesInput").focus();
    });

    document.getElementById("noNoteBtn").addEventListener("click", () => {
      document.getElementById("notesChoiceSection").classList.add("hidden");
      showHypePhraseStep();
    });

    document.getElementById("submitNoteBtn").addEventListener("click", () => {
      const note = document.getElementById("notesInput").value.trim();
      document.getElementById("notesInputSection").classList.add("hidden");

      window.latestNote = note || "N/A";

      showHypePhraseStep();
    });

    document.getElementById("notesInput").addEventListener("input", (e) => {
      const remaining = 100 - e.target.value.length;
      document.getElementById("charCount").textContent = `Remaining: ${remaining}`;
    });

    function showHypePhraseStep() {
      document.getElementById("notesChoiceSection").classList.add("hidden");
      document.getElementById("notesInputSection").classList.add("hidden");
      document.getElementById("hypePhraseStep").classList.remove("hidden");

      populateHypeACategories();
    }

    // The rest of your original hype phrase functions and generateFinalOutput remain exactly the same (no modifications to your original code for those)...

    // Just as a safeguard, explicitly call buildUnitDropdown listener:
    document.getElementById("unitDropdown").addEventListener("change", () => {
      submitUnitAmount();
    });

  </script>

</body>
</html>
